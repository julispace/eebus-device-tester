<!doctype html>
<html lang="de">
<head>
    <meta charset="utf-8"/>
    <title>EEBUS Device Tester</title>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <style>
        :root {
            --bg: #f6f8fa;
            --card: #ffffff;
            --muted: #6b7280;
            --accent: #2563eb;
            --success: #059669;
            --danger: #ef4444;
            --code-bg: #111;
            --code-color: #bada55;
        }

        html, body {
            height: 100%;
            margin: 0;
            background: var(--bg);
            font-family: Inter, Roboto, Arial, sans-serif;
            color: #111
        }

        .app {
            display: flex;
            flex-direction: column;
            height: 100vh;
            gap: 12px;
            padding: 12px;
            box-sizing: border-box;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        h1 {
            font-size: 20px;
            margin: 0
        }

        h5 {
            margin: 10px 0 2px 0;
            display: block;
            width: 100%;
            border-bottom: 1px solid rgba(0, 0, 0, 0.2);
        }

        .top {
            display: flex;
            gap: 12px;
            align-items: stretch;
        }

        .card {
            background: var(--card);
            border-radius: 8px;
            box-shadow: 0 1px 2px rgba(16, 24, 40, 0.03);
            padding: 12px;
        }

        /* draggable splitter between left and right columns */
        .splitter {
            width: 8px;
            cursor: col-resize;
            background: linear-gradient(90deg, transparent, rgba(0, 0, 0, 0.06), transparent);
            border-radius: 4px;
            align-self: stretch;
        }

        .splitter:hover {
            background: linear-gradient(90deg, transparent, rgba(0, 0, 0, 0.12), transparent);
        }

        .panel {
            display: flex;
            flex-direction: column;
            gap: 8px
        }

        /* left column (small) */
        #leftColumn { /* much smaller to give parsed traces priority */
            width: 300px;
            min-width: 440px;
            max-width: 620px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 12px;
            box-sizing: border-box;
            align-self: stretch;
            min-height: 0;
        }

        /* control panel: labels above inputs */
        .field-row {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 6px
        }

        label {
            color: var(--muted);
            font-size: 13px
        }

        .usecase-label {
            font-weight: 600;
        }

        /* Usecase section header with support status */
        .usecase-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .usecase-header .usecase-label {
            font-weight: 600;
            font-size: 14px;
        }

        .support-badge {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
        }

        .support-badge.supported {
            background: #d1fae5;
            color: #065f46;
        }

        .support-badge.unsupported {
            background: #f3f4f6;
            color: #6b7280;
        }

        /* Usecase content - greyed out when unsupported */
        .usecase-content {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .usecase-content.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .usecase-content.disabled input,
        .usecase-content.disabled button {
            pointer-events: none;
        }

        .data-label {
            font-size: 12px;
            color: var(--muted);
        }

        .data-container {
            min-width: 80px;
        }

        .data-value {
            font-weight: 600;
            font-size: 13px;
        }

        /* New styles for manufacturer details */
        .manufacturer-wrapper {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .manufacturer-details {
            overflow: auto;
            /* details are shown by JS as flex when opened to allow internal layout; max-height is set by JS */
            display: none; /* default hidden; JS switches to 'flex' when opened */
            flex-direction: column;
            gap: 6px;
            /* ensure details never exceed the left panel height (which equals .top height) */
            /*max-height: var(--panel-height);*/
        }

        input[type="text"], input[type="number"], select {
            padding: 6px 8px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            width: 100%;
            box-sizing: border-box;
        }

        button {
            background: var(--accent);
            color: white;
            border: 0;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer
        }

        button.secondary {
            background: #e5e7eb;
            color: #111
        }

        /* usecases */
        #usecaseList {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .usecase {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: #fbfdff;
            border-radius: 6px;
            border: 1px solid #f1f5f9
        }

        .usecase .state.supported {
            color: var(--success);
            font-weight: 600
        }

        .usecase .state.unsupported {
            color: var(--muted)
        }

        /* right column */
        /* SPINE Messages & Trace Log tabs */
        #parsedPanel {
            padding: 12px;
            flex: 1;
            min-width: 200px;
            display: flex;
            flex-direction: column;
            align-self: stretch;
            min-height: 0;
        }

        #parsedTracesList {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 4px;
            max-height: 1000px;
            overflow: auto;
        }

        #parsedTracesList li {
            padding: 6px 8px;
            margin: 4px 0;
            border-radius: 6px;
            display: flex;
            gap: 8px;
            align-items: center;
            cursor: pointer;
            background: #fff;
            box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.02) inset;
            font-size: 13px;
            line-height: 18px;
        }

        #parsedTracesList li.selected {
            background: #e8f0ff;
            box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.12) inset;
        }

        .trace-meta {
            display: flex;
            gap: 10px;
            align-items: center;
            font-size: 13px;
            color: #111
        }

        .trace-ts {
            color: var(--muted);
            width: 150px
        }

        .dir-recv {
            color: var(--accent);
            font-weight: 700
        }

        .dir-send {
            color: purple;
            font-weight: 700
        }

        /* entities tree */
        #entitiesPanel {
            margin-bottom: 10px;
        }

        #entitiesList {
            list-style: none;
            padding: 0;
            margin: 0;
            border: 1px solid #eef2ff;
            border-radius: 6px;
            /* show all entries, no internal scroll */
        }

        #entitiesList li {
            padding: 8px;
            border-bottom: 1px solid #f1f5f9;
            cursor: pointer
        }

        #entitiesList li .sub {
            margin-left: 12px;
            font-size: 13px;
            color: #333
        }

        .tree-toggle {
            display: inline-block;
            width: 18px;
            text-align: center;
            color: var(--muted)
        }

        .entity-addr {
            font-weight: 600
        }

        /* detail panel */
        #traceDetailPanel {
            position: relative;
            margin-top: 8px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        #traceDetail {
            display: none;
            white-space: pre-wrap;
            background: #0b1220;
            color: #dbeafe;
            padding: 12px;
            border-radius: 6px;
            overflow: auto;
            flex: 1;
            max-height: 50%;
            min-height: 0;
        }

        #traceDetail.header {
            display: flex;
        }

        #traceDetailClose {
            position: absolute;
            right: 8px;
            top: 8px;
            background: transparent;
            border: 0;
            color: #fff;
            cursor: pointer
        }

        /* logs bottom */
        footer .card {
            padding: 8px
        }

        #logs {
            white-space: pre-wrap;
            background: var(--code-bg);
            color: var(--code-color);
            padding: 10px;
            height: 180px;
            overflow: auto;
            border-radius: 6px
        }

        /* responsive */
        @media (max-width: 900px) {
            .top {
                grid-template-columns: 1fr;
            }

            #parsedTracesList {
                max-height: 200px
            }
        }

        /* Style the tab */
        .tab {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
        }

        /* Style the buttons that are used to open the tab content */
        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            color: black;
        }

        /* Change background color of buttons on hover */
        .tab button:hover {
            background-color: #ddd;
        }

        /* Create an active/current tablink class */
        .tab button.active {
            background-color: #ccc;
        }

        /* Style the tab content */
        .tabcontent {
            display: none;
            padding: 6px 12px;
            border: 1px solid #ccc;
            border-top: none;
            flex: 1;
            overflow: auto;
            min-height: 0;
        }

        #tabContent {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
            min-height: 0;
        }

        @keyframes flash-bg {
            0% {
                background-color: rgba(37, 99, 235, 0.24);
            }
            60% {
                background-color: rgba(37, 99, 235, 0.12);
            }
            100% {
                background-color: transparent;
            }
        }

        .flash-change {
            animation: flash-bg 3s ease-out;
            border-radius: 6px; /* optional, passt zu list items */
        }
    </style>
</head>
<body>
<div class="app">
    <header>
        <h1>EEBUS Device Tester</h1>
        <div style="color:var(--muted);font-size:13px">Local web UI</div>
    </header>

    <div class="top">
        <div class="card panel" id="leftColumn">

            <section id="dataControlPanel" class="card" style="padding:12px">
                <h3 style="margin:0 0 6px 0">Data and Control</h3>

                <div style="display:flex;flex-direction:column;gap:8px">
                    <!-- LPC-->
                    <div class="usecase-header">
                        <div class="usecase-label">LPC</div>
                        <span id="lpcBadge" class="support-badge unsupported">not supported</span>
                    </div>
                    <div id="lpcContent" class="usecase-content disabled">
                        <h5>Scenario 1 - Control active power consumption</h5>
                        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                            <div class="data-container">
                                <div class="data-label">Limit (W)</div>
                                <div id="lpcLimitValue" class="data-value">-</div>
                            </div>
                            <div class="data-container">
                                <div class="data-label">Duration (s)</div>
                                <div id="lpcLimitDur" class="data-value">-</div>
                            </div>
                            <div class="data-container">
                                <div class="data-label">Active</div>
                                <div id="lpcLimitActive" class="data-value">-</div>
                            </div>
                        </div>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <input id="writeLimitValue" type="number" placeholder="value (W)" style="width:90px"
                                   value="3600"/>
                            <input id="writeLimitDurationSec" type="number" placeholder="duration (s)"
                                   style="width:90px" value="600"/>
                            <label style="display:flex;align-items:center;gap:6px;margin:0"><input id="writeLimitActive"
                                                                                                   type="checkbox"
                                                                                                   checked/>
                                Active</label>
                            <button id="sendWriteLimit">Send Loadcontrol Limit</button>
                        </div>
                        <h5>Scenario 2 - Failsafe</h5>
                        <div style="display:flex; gap:8px; align-items:center; margin-top:8px;">
                            <div class="data-container">
                                <div class="data-label">Failsafe Power (W)</div>
                                <div id="lpcFailsafePower" class="data-value">-</div>
                            </div>
                            <div class="data-container">
                                <div class="data-label">Failsafe Duration (min)</div>
                                <div id="lpcFailsafeDuration" class="data-value">-</div>
                            </div>
                        </div>
                        <div style="display:flex; gap:8px; align-items:center; margin-top:6px;">
                            <input id="writeFailsafePower" type="number" placeholder="failsafe power (W)"
                                   style="width:120px" value="2500"/>
                            <input id="writeFailsafeDurationMin" type="number" placeholder="duration (min)"
                                   style="width:120px" value="300"/>
                            <button id="sendWriteFailsafePower">Send Failsafe Power</button>
                            <button id="sendWriteFailsafeDuration">Send Failsafe Duration</button>
                        </div>
                        <h5>Scenario 3 - Heartbeat</h5>
                        <div style="display:flex; gap:8px; align-items:center; margin-top:8px;">
                            <div class="data-container">
                                <div class="data-label">Heartbeat Received</div>
                                <div id="lpcHeartbeat" class="data-value">-</div>
                            </div>
                            <div class="data-container">
                                <div class="data-label">Last Heartbeat Time</div>
                                <div id="lpcHeartbeatTimestamp" class="data-value">-</div>
                            </div>
                        </div>
                        <h5>Scenario 4 - Constraints</h5>
                        <div style="display:flex; gap:8px; align-items:center; margin-top:8px;">
                            <div class="data-container">
                                <div class="data-label">Maximum possible Power Consumption (W)</div>
                                <div id="lpcMaxNominalPower" class="data-value">-</div>
                            </div>
                        </div>
                    </div>

                    <div style="height:1px;background:grey;margin:6px 0"></div>
                    <!-- LPP-->
                    <div class="usecase-header">
                        <div class="usecase-label">LPP</div>
                        <span id="lppBadge" class="support-badge unsupported">not supported</span>
                    </div>
                    <div id="lppContent" class="usecase-content disabled">
                        <h5>Scenario 1 - Control active power production</h5>
                        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                            <div class="data-container">
                                <div class="data-label">Limit (W)</div>
                                <div id="lppLimitValue" class="data-value">-</div>
                            </div>
                            <div class="data-container">
                                <div class="data-label">Duration (s)</div>
                                <div id="lppLimitDur" class="data-value">-</div>
                            </div>
                            <div class="data-container">
                                <div class="data-label">Active</div>
                                <div id="lppLimitActive" class="data-value">-</div>
                            </div>
                        </div>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <input id="writeLppLimitValue" type="number" placeholder="value (W)" style="width:90px" value="3600"/>
                            <input id="writeLppLimitDurationSec" type="number" placeholder="duration (s)" style="width:90px" value="600"/>
                            <label style="display:flex;align-items:center;gap:6px;margin:0"><input id="writeLppLimitActive" type="checkbox" checked/> Active</label>
                            <button id="sendWriteLppLimit">Send Production Limit</button>
                        </div>
                        <h5>Scenario 2 - Failsafe</h5>
                        <div style="display:flex; gap:8px; align-items:center; margin-top:8px;">
                            <div class="data-container">
                                <div class="data-label">Failsafe Power (W)</div>
                                <div id="lppFailsafeValue" class="data-value">-</div>
                            </div>
                            <div class="data-container">
                                <div class="data-label">Failsafe Duration (min)</div>
                                <div id="lppFailsafeDur" class="data-value">-</div>
                            </div>
                        </div>
                        <div style="display:flex; gap:8px; align-items:center; margin-top:6px;">
                            <input id="writeLppFailsafePower" type="number" placeholder="failsafe power (W)" style="width:120px" value="2500"/>
                            <input id="writeLppFailsafeDurationMin" type="number" placeholder="duration (min)" style="width:120px" value="300"/>
                            <button id="sendWriteLppFailsafePower">Send Failsafe Power</button>
                            <button id="sendWriteLppFailsafeDuration">Send Failsafe Duration</button>
                        </div>
                    </div>
                    <div style="height:1px;background:grey;margin:6px 0"></div>

                    <!-- EVSECC-->
                    <div class="usecase-header">
                        <div class="usecase-label">EVSECC</div>
                        <span id="evseccBadge" class="support-badge unsupported">not supported</span>
                    </div>
                    <div id="evseccContent" class="usecase-content disabled">
                        <h5>Scenario 1 - EVSE sends manufacturer info</h5>
                        <div class="data-container">
                            <div class="data-label">Manufacturer Data</div>
                            <div id="evseccManufacturer" class="data-value">-</div>
                        </div>
                        <h5>Scenario 2 - EVSE sends error state</h5>
                        <div style="display:flex; gap:8px; align-items:center; margin-top:8px;">
                            <div class="data-container">
                                <div class="data-label">Operating State</div>
                                <div id="evseccOperatingState" class="data-value">-</div>
                            </div>
                            <div class="data-container">
                                <div class="data-label">Error Message</div>
                                <div id="evseccErrorMessage" class="data-value">-</div>
                            </div>
                        </div>
                    </div>
                    <div style="height:1px;background:grey;margin:6px 0"></div>

                    <!-- EVCC-->
                    <div class="usecase-header">
                        <div class="usecase-label">EVCC</div>
                        <span id="evccBadge" class="support-badge unsupported">not supported</span>
                    </div>
                    <div id="evccContent" class="usecase-content disabled">
                        <h5>Scenario 1 - EV Connected & Scenario 8 - EV disconnected</h5>
                        <div class="data-container">
                            <div class="data-label">Operating State</div>
                            <div id="evccEvConnected" class="data-value">-</div>
                        </div>
                        <h5>Scenario 2 - EV sends communication standard</h5>
                        <div class="data-container">
                            <div class="data-label">Communication Standard</div>
                            <div id="evccCommStandard" class="data-value">-</div>
                        </div>
                        <h5>Scenario 3 - EV sends support of asymmetric charging</h5>
                        <div class="data-container">
                            <div class="data-label">Asymmetric Charging supported</div>
                            <div id="evccAsymmetricCharging" class="data-value">-</div>
                        </div>
                        <h5>Scenario 4 - EV sends identification</h5>
                        <div class="data-container">
                            <div class="data-label">MAC type</div>
                            <div id="evccIdentificationType" class="data-value">-</div>
                        </div>
                        <div class="data-container">
                            <div class="data-label">MAC Address</div>
                            <div id="evccIdentificationValue" class="data-value">-</div>
                        </div>
                        <h5>Scenario 5 - EV sends manufacturer</h5>
                        <div class="data-container">
                            <div class="data-label">Manufacturer Data</div>
                            <div id="evccManufacturer" class="data-value">-</div>
                        </div>
                        <h5>Scenario 6 - EV sends charging power limits</h5>
                        <div class="data-container">
                            <div class="data-label">Minimum Charging Power (W)</div>
                            <div id="evccChargingLimitsMin" class="data-value">-</div>
                        </div>
                        <div class="data-container">
                            <div class="data-label">Maximum Charging Power (W)</div>
                            <div id="evccChargingLimitsMax" class="data-value">-</div>
                        </div>
                        <div class="data-container">
                            <div class="data-label">Standby Charging Power (W)</div>
                            <div id="evccChargingLimitsStandy" class="data-value">-</div>
                        </div>
                        <h5>Scenario 7 - EV sleep mode</h5>
                        <div class="data-container">
                            <div class="data-label">EV Sleep Mode active</div>
                            <div id="evccSleepMode" class="data-value">-</div>
                        </div>
                    </div>
                    <div style="height:1px;background:grey;margin:6px 0"></div>

                    <!-- EVCEM-->
                    <div class="usecase-header">
                        <div class="usecase-label">EVCEM</div>
                        <span id="evcemBadge" class="support-badge unsupported">not supported</span>
                    </div>
                    <div id="evcemContent" class="usecase-content disabled">
                        <h5>Scenario 1 - Measure EV Charging current</h5>
                        <div class="data-container">
                            <div class="data-label">Charging Current per Phase (A)</div>
                            <div id="evcemChargingCurrent" class="data-value">-</div>
                        </div>
                        <h5>Scenario 2 - Measure EV charging Power</h5>
                        <div class="data-container">
                            <div class="data-label">Charging Power per Phase (W)</div>
                            <div id="evcemChargingPower" class="data-value">-</div>
                        </div>
                        <h5>Scenario 3 - Measure EV charging energy</h5>
                        <div class="data-container">
                            <div class="data-label">Energy Charged (Wh)</div>
                            <div id="evcemChargedEnergy" class="data-value">-</div>
                        </div>
                    </div>
                    <div style="height:1px;background:grey;margin:6px 0"></div>

                    <!-- OPEV-->
                    <div class="usecase-header">
                        <div class="usecase-label">OPEV</div>
                        <span id="opevBadge" class="support-badge unsupported">not supported</span>
                    </div>
                    <div id="opevContent" class="usecase-content disabled">
                        <h5>Scenario 1 - Energy Guard curtails charging current of EV</h5>
                        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                            <div class="data-container">
                                <div class="data-label">Load Control Limit (A)</div>
                                <div id="opevLoadLimit" class="data-value">-</div>
                            </div>
                        </div>
                        <h5>Scenario 2 - Current Limits</h5>
                        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                            <div class="data-container">
                                <div class="data-label">Minimum (A)</div>
                                <div id="opevCurrentLimitMin" class="data-value">-</div>
                            </div>
                            <div class="data-container">
                                <div class="data-label">Maximum (A)</div>
                                <div id="opevCurrentLimitMax" class="data-value">-</div>
                            </div>
                            <div class="data-container">
                                <div class="data-label">Default (A)</div>
                                <div id="opevCurrentLimitDefault" class="data-value">-</div>
                            </div>
                        </div>
                    </div>
                    <div style="height:1px;background:grey;margin:6px 0"></div>

                    <!-- OSCEV-->
                    <div class="usecase-header">
                        <div class="usecase-label">OSCEV</div>
                        <span id="oscevBadge" class="support-badge unsupported">not supported</span>
                    </div>
                    <div id="oscevContent" class="usecase-content disabled">
                        <h5>Scenario 1 - CEM sends recommended charging power</h5>
                        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                            <div class="data-container">
                                <div class="data-label">Load Control Limit (A)</div>
                                <div id="oscevLoadLimit" class="data-value">-</div>
                            </div>
                        </div>
                        <div style="display:flex; gap:8px; align-items:center; margin-top:8px;">
                            <input id="writeOscevLimitValue" type="number" placeholder="limit (A)" style="width:90px" value="16"/>
                            <label style="display:flex;align-items:center;gap:6px;margin:0"><input id="writeOscevLimitActive" type="checkbox" checked/> Active</label>
                            <button id="sendWriteOscevLimit">Send Load Control Limit</button>
                        </div>
                        <h5>Scenario 2 - Current Limits</h5>
                        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                            <div class="data-container">
                                <div class="data-label">Minimum (A)</div>
                                <div id="oscevCurrentLimitMin" class="data-value">-</div>
                            </div>
                            <div class="data-container">
                                <div class="data-label">Maximum (A)</div>
                                <div id="oscevCurrentLimitMax" class="data-value">-</div>
                            </div>
                            <div class="data-container">
                                <div class="data-label">Default (A)</div>
                                <div id="oscevCurrentLimitDefault" class="data-value">-</div>
                            </div>
                        </div>
                    </div>
                    <div style="height:1px;background:grey;margin:6px 0"></div>

                    <!-- EVSOC-->
                    <div class="usecase-header">
                        <div class="usecase-label">EVSOC</div>
                        <span id="evsocBadge" class="support-badge unsupported">not supported</span>
                    </div>
                    <div id="evsocContent" class="usecase-content disabled">
                        <h5>Scenario 1 - EV sends current state of charge</h5>
                        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                            <div class="data-container">
                                <div class="data-label">State of Charge (%)</div>
                                <div id="evsocStateOfCharge" class="data-value">-</div>
                            </div>
                        </div>
                    </div>
                    <div style="height:1px;background:grey;margin:6px 0"></div>

                    <!-- CEVC-->
                    <div class="usecase-header">
                        <div class="usecase-label">CEVC</div>
                        <span id="cevcBadge" class="support-badge unsupported">not supported</span>
                    </div>
                    <div id="cevcContent" class="usecase-content disabled">
                        <h5>Charge Strategy</h5>
                        <div class="data-container">
                            <div class="data-label">Current Strategy</div>
                            <div id="cevcChargeStrategy" class="data-value">-</div>
                        </div>
                        <h5>Energy Demand</h5>
                        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                            <div class="data-container">
                                <div class="data-label">Min Demand (Wh)</div>
                                <div id="cevcMinDemand" class="data-value">-</div>
                            </div>
                            <div class="data-container">
                                <div class="data-label">Opt Demand (Wh)</div>
                                <div id="cevcOptDemand" class="data-value">-</div>
                            </div>
                            <div class="data-container">
                                <div class="data-label">Max Demand (Wh)</div>
                                <div id="cevcMaxDemand" class="data-value">-</div>
                            </div>
                            <div class="data-container">
                                <div class="data-label">Duration Until Start (s)</div>
                                <div id="cevcDurationStart" class="data-value">-</div>
                            </div>
                            <div class="data-container">
                                <div class="data-label">Duration Until End (s)</div>
                                <div id="cevcDurationEnd" class="data-value">-</div>
                            </div>
                        </div>
                        <h5>Charge Plan</h5>
                        <div class="data-container">
                            <div class="data-label">Charge Plan Slots</div>
                            <div id="cevcChargePlan" class="data-value" style="white-space:pre-wrap;font-size:11px;">-</div>
                        </div>
                    </div>
                    <div style="height:1px;background:grey;margin:6px 0"></div>

                    <!-- MPC-->
                    <div class="usecase-header">
                        <div class="usecase-label">MPC</div>
                        <span id="mpcBadge" class="support-badge unsupported">not supported</span>
                    </div>
                    <div id="mpcContent" class="usecase-content disabled">
                        <h5>Power Measurements</h5>
                        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                            <div class="data-container">
                                <div class="data-label">Total Power (W)</div>
                                <div id="mpcPower" class="data-value">-</div>
                            </div>
                            <div class="data-container">
                                <div class="data-label">Power per Phase (W)</div>
                                <div id="mpcPowerPerPhase" class="data-value">-</div>
                            </div>
                        </div>
                        <h5>Current and Voltage</h5>
                        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                            <div class="data-container">
                                <div class="data-label">Current per Phase (A)</div>
                                <div id="mpcCurrentPerPhase" class="data-value">-</div>
                            </div>
                            <div class="data-container">
                                <div class="data-label">Voltage per Phase (V)</div>
                                <div id="mpcVoltagePerPhase" class="data-value">-</div>
                            </div>
                            <div class="data-container">
                                <div class="data-label">Frequency (Hz)</div>
                                <div id="mpcFrequency" class="data-value">-</div>
                            </div>
                        </div>
                        <h5>Energy</h5>
                        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                            <div class="data-container">
                                <div class="data-label">Energy Consumed (Wh)</div>
                                <div id="mpcEnergyConsumed" class="data-value">-</div>
                            </div>
                            <div class="data-container">
                                <div class="data-label">Energy Produced (Wh)</div>
                                <div id="mpcEnergyProduced" class="data-value">-</div>
                            </div>
                        </div>
                    </div>

                </div>

            </section>

            <!-- Entities panel moved to left column under Usecases -->
            <section id="entitiesLeft" class="card" style="padding:12px">
                <h3 style="margin:0 0 6px 0">Entities</h3>
                <div id="entitiesStatus" style="color:var(--muted); font-size:13px; margin-bottom:6px">Loading
                    entities...
                </div>
                <ul id="entitiesList"></ul>
            </section>
        </div>

        <div id="splitter" class="splitter" title="Drag to resize"></div>
        <div class="card panel" id="parsedPanel"
             style="padding:12px; flex:1; min-width:200px; display:flex; flex-direction:column;">
            <h3 style="margin:0 0 6px 0">SPINE Messages / Trace Log</h3>
            <div class="tab">
                <button class="tablinks" onclick="openTab(event, 'spineContent')" id="defaultOpen">Spine Messages
                </button>
                <button class="tablinks" onclick="openTab(event, 'logContent')">Tracelog</button>
            </div>
            <!--<div style="display:flex; gap:8px; margin-bottom:8px;">
                <button id="tabSpine" class="secondary">SPINE Messages</button>
                <button id="tabLog" class="secondary">Trace Log</button>
            </div>-->
            <div id="tabContent" style="display:flex; flex-direction:column; gap:8px; flex:1;">
                <div class="tabcontent" id="spineContent" style="display:block; flex:1; overflow:auto">
                    <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
                        <div id="parsedTracesStatus" style="color:var(--muted); font-size:13px">Waiting for spine
                            messages...
                        </div>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <label style="font-size:13px;color:var(--muted);"><input id="eebusJsonCheckbox"
                                                                                     type="checkbox" checked
                                                                                     style="margin-right:6px;">EEBUS
                                Json Format</label>
                            <button id="clearParsed" class="secondary" type="button">Clear Parsed</button>
                        </div>
                    </div>
                    <ul id="parsedTracesList"></ul>

                    <div id="traceDetailPanel">
                        <div style="display:flex; align-items:center; gap:8px; justify-content:space-between;">
                            <div style="font-size:13px;color:var(--muted);">Click an entry to view the full JSON</div>
                            <button id="traceDetailClose" title="Close detail" style="display:none">âœ–</button>
                        </div>
                        <div id="traceDetail">Click an entry to view the full JSON.</div>
                    </div>
                </div>

                <div class="tabcontent" id="logContent" style="display:none; flex-direction:column; gap:8px;">
                    <div style="display:flex; align-items:center; justify-content:space-between;">
                        <div style="color:var(--muted);">Trace Log (raw)</div>
                        <button id="logsToBottomBtn"
                                style="display:none; background:#2563eb; color:#fff; border:0; padding:6px 10px; border-radius:6px; cursor:pointer">
                            Scroll to bottom
                        </button>
                    </div>
                    <div id="logs"
                         style="white-space:pre-wrap; background:#0b1220; color:#dbeafe; padding:10px; height:240px; overflow:auto; border-radius:6px">
                        Connecting to log websocket...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- no footer -->
</div>

<script>
    // --- UI helpers ---
    function intInputSanitize(el) {
        if (!el) return;
        el.addEventListener('input', () => {
            // remove non-digit characters
            const v = el.value;
            const m = v.match(/^\d*/);
            if (m && m[0] !== v) el.value = m[0];
        });
    }

    const flashElement = (el) => {
        if (!el) return;
        el.classList.remove('flash-change');
        // force reflow to restart animation
        void el.offsetWidth;
        el.classList.add('flash-change');

        function onEnd() {
            el.classList.remove('flash-change');
            el.removeEventListener('animationend', onEnd);
        }

        el.addEventListener('animationend', onEnd);
    };
    // Setup elements safely
    const cmdSelect = document.getElementById('cmdSelect');

    function openTab(evt, tabName) {
        // Declare all variables
        var i, tabcontent, tablinks;

        // Get all elements with class="tabcontent" and hide them
        tabcontent = document.getElementsByClassName("tabcontent");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }

        // Get all elements with class="tablinks" and remove the class "active"
        tablinks = document.getElementsByClassName("tablinks");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }

        // Show the current tab, and add an "active" class to the button that opened the tab
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " active";
    }

    document.getElementById("defaultOpen").click();

    // Usecases - setUsecase updates display toggles for usecase panels
    function displaySupportedUsecases(list) {
        if (!list || list.length === 0) return;
        const seen = new Set();
        list.forEach(u => {
            if (!u || !u.name) return;
            if (seen.has(u.name)) return;
            seen.add(u.name);
            setUsecase(u.name, u.supported);
        });
    }

    async function loadUsecases() {
        try {
            const res = await fetch('/api/usecases');
            if (!res.ok) return;
            const list = await res.json();
            displaySupportedUsecases(list);
        } catch (err) {
            // ignore errors
        }
    }

    function setUsecase(name, supported) {
        // This function is overridden below to update the display panels
    }

    // --- Parsed trace handling helpers ---
    function extractTimestamp(line) {
        const ts = (typeof line === 'string') ? line.slice(0, 19) : '';
        if (/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/.test(ts)) return ts;
        return ''
    }

    function extractDirection(line) {
        if (typeof line !== 'string') return '';
        const m = line.match(/TRACE\s*(Recv|Send)/i) || line.match(/Trace\s*(Recv|Send)/i);
        return m ? m[1].toLowerCase() : ''
    }

    function extractJsonString(line) {
        if (typeof line !== 'string') return null;
        const idx = line.indexOf('{');
        if (idx === -1) return null;
        return line.slice(idx)
    }

    function safeHasOwn(obj, key) {
        return Object.prototype.hasOwnProperty.call(obj, key)
    }

    function findValueByKey(obj, key) {
        if (!obj || typeof obj !== 'object') return undefined;
        if (safeHasOwn(obj, key)) return obj[key];
        for (const k in obj) {
            if (!safeHasOwn(obj, k)) continue;
            const v = obj[k];
            if (typeof v === 'object') {
                const found = findValueByKey(v, key);
                if (found !== undefined) return found
            }
        }
        return undefined
    }

    function findCmdType(obj) {
        const cmd = findValueByKey(obj, 'cmd');
        if (!cmd) return '';

        function findObjInArray(a) {
            if (!Array.isArray(a)) return null;
            for (const item of a) {
                if (!item) continue;
                if (typeof item === 'object' && !Array.isArray(item)) {
                    for (const k in item) {
                        if (Object.prototype.hasOwnProperty.call(item, k)) return k
                    }
                }
                if (Array.isArray(item)) {
                    const deeper = findObjInArray(item);
                    if (deeper) return deeper
                }
            }
            return null
        }

        const t = findObjInArray(cmd);
        return t || ''
    }

    const parsedTraces = [];
    let parsedIdCounter = 1;

    function addParsedTrace(entry) {
        entry.id = parsedIdCounter++;
        parsedTraces.unshift(entry);
        if (parsedTraces.length > 500) parsedTraces.pop();
        renderParsedTraces();
    }

    function clearParsedTraces() {
        parsedTraces.length = 0;
        renderParsedTraces();
        const detail = document.getElementById('traceDetail');
        if (detail) {
            detail.textContent = 'Click an entry to view the full JSON.';
            detail.style.display = 'none';
        }
        const btn = document.getElementById('traceDetailClose');
        if (btn) btn.style.display = 'none';

        // Entferne alle selektierten Listenelemente
        try {
            const sel = document.querySelectorAll('#parsedTracesList li.selected');
            sel.forEach(el => el.classList.remove('selected'));
        } catch (e) {
        }
        lastShownPT = null;
    }

    function renderParsedTraces() {
        const list = document.getElementById('parsedTracesList');
        if (!list) return;
        list.innerHTML = '';
        if (parsedTraces.length === 0) {
            document.getElementById('parsedTracesStatus').textContent = 'Waiting for traces...';
            return
        }
        document.getElementById('parsedTracesStatus').textContent = '';
        // only show up to 10 visible items but keep list scrollable
        parsedTraces.forEach(pt => {
            const li = document.createElement('li');
            li.id = 'pt-' + pt.id;
            const ts = document.createElement('div');
            ts.className = 'trace-ts';
            ts.textContent = pt.ts || '';
            const dir = document.createElement('div');
            dir.className = (pt.direction === 'recv' ? 'dir-recv' : 'dir-send');
            dir.textContent = (pt.direction || '').toUpperCase();
            const meta = document.createElement('div');
            meta.className = 'trace-meta';
            meta.innerHTML = '<span style="color:var(--muted)">cmdClassifier:</span> ' + (pt.cmdClassifier || '-') + ' &nbsp; <span style="color:var(--muted)">type:</span> ' + (pt.cmdType || '-');
            li.appendChild(ts);
            li.appendChild(dir);
            li.appendChild(meta);
            li.addEventListener('click', () => showTraceDetail(pt));
            list.appendChild(li);
        })
    }

    /* --- Entities rendering (cascading list) --- */
    // remember expanded state across renders: key = entityAddress + '::' + featureIndex
    const expandedStates = {};

    function renderEntities(data) {
        const container = document.getElementById('entitiesList');
        if (!container) return;
        // preserve scroll and expanded state
        const prevScroll = container ? container.scrollTop : 0;
        const prevExpanded = Object.assign({}, expandedStates);
        container.innerHTML = '';
        if (!data || data.length === 0) {
            document.getElementById('entitiesStatus').textContent = 'No entities available';
            return;
        }
        document.getElementById('entitiesStatus').textContent = '';
        data.forEach((ent, entIndex) => {
            const li = document.createElement('li');
            const entKey = String(ent.address || '') || ('ent-' + entIndex);
            const toggle = document.createElement('span');
            toggle.className = 'tree-toggle';
            toggle.textContent = '+';
            const title = document.createElement('span');
            title.className = 'entity-addr';
            title.textContent = (ent.address || '') + ' ';
            const etype = document.createElement('span');
            etype.style.color = 'var(--muted)';
            etype.style.fontSize = '13px';
            etype.textContent = (ent.entityType ? ('[' + ent.entityType + ']') : '');
            li.appendChild(toggle);
            li.appendChild(title);
            li.appendChild(etype);

            const sub = document.createElement('div');
            sub.className = 'sub';
            sub.style.display = 'none';
            // features
            if (Array.isArray(ent.features)) {
                ent.features.forEach((f, featIndex) => {
                    const fdiv = document.createElement('div');
                    const fname = document.createElement('div');
                    fname.style.fontWeight = '600';
                    fname.textContent = (f.name || '');
                    const froles = document.createElement('div');
                    froles.style.color = 'var(--muted)';
                    froles.textContent = 'Roles: ' + (f.roles || '');
                    fdiv.appendChild(fname);
                    fdiv.appendChild(froles);
                    // operations
                    if (Array.isArray(f.operations) && f.operations.length > 0) {
                        const opl = document.createElement('ul');
                        opl.style.margin = '6px 0 8px 12px';
                        opl.style.padding = '0 0 0 14px';
                        opl.style.listStyle = 'disc';
                        f.operations.forEach(op => {
                            const oli = document.createElement('li');
                            const opKey = (op.op !== undefined && op.op !== null) ? String(op.op) : '';
                            const opName = (op.name !== undefined && op.name !== null) ? String(op.name) : '';
                            if (opKey && opName) {
                                oli.textContent = opKey + ' â€” ' + opName;
                            } else if (opName) {
                                oli.textContent = opName;
                            } else {
                                oli.textContent = opKey;
                            }
                            opl.appendChild(oli);
                        });
                        fdiv.appendChild(opl);
                    }
                    // restore expanded state for this feature
                    const featKey = entKey + '::' + String(featIndex);
                    if (prevExpanded[featKey]) {
                        fdiv.style.display = 'block';
                    }
                    sub.appendChild(fdiv);
                });
            }
            li.appendChild(sub);
            // restore toggled state if any feature is expanded
            const anyExpanded = Object.keys(prevExpanded).some(k => k.startsWith(entKey + '::'));
            if (anyExpanded) {
                sub.style.display = 'block';
                toggle.textContent = 'âˆ’';
            }

            toggle.addEventListener('click', (e) => {
                const isOpen = sub.style.display !== 'none';
                if (isOpen) {
                    sub.style.display = 'none';
                    toggle.textContent = '+';
                    // clear expanded flags for this entity
                    Object.keys(expandedStates).forEach(k => {
                        if (k.startsWith(entKey + '::')) delete expandedStates[k];
                    });
                } else {
                    sub.style.display = 'block';
                    toggle.textContent = 'âˆ’';
                    // mark all child features as expanded
                    const featCount = (Array.isArray(ent.features) ? ent.features.length : 0);
                    for (let i = 0; i < featCount; i++) {
                        expandedStates[entKey + '::' + i] = true;
                    }
                }
            });
            // clicking title toggles as well
            title.addEventListener('click', () => {
                toggle.click();
            });
            container.appendChild(li);
        });
        // restore scroll position
        try {
            container.scrollTop = prevScroll;
        } catch (e) {
        }
    }

    // load entities from API (initial)
    async function loadEntities() {
        try {
            const res = await fetch('/api/entities');
            if (!res.ok) {
                document.getElementById('entitiesStatus').textContent = 'Failed to load entities';
                return;
            }
            const data = await res.json();
            // server may respond with array or with {type:..., entities: [...]}
            let arr = [];
            if (Array.isArray(data)) arr = data;
            else if (data && Array.isArray(data.entities)) arr = data.entities;
            renderEntities(arr);
        } catch (e) {
            document.getElementById('entitiesStatus').textContent = 'Error loading entities: ' + e
        }
    }

    // --- Trace detail helpers ---
    function eebusJsonToJson(jsonStr) {
        if (typeof jsonStr !== 'string') jsonStr = String(jsonStr || '');
        try {
            let s = jsonStr;
            // Apply the simple transformations from the C++ routine
            s = s.replace(/\[\]/g, '{}');
            s = s.replace(/\}\]/g, '}');
            s = s.replace(/\},\{/g, ',');
            s = s.replace(/\[\{/g, '{');
            s = s.trim();

            // Try to parse the transformed string; if successful, pretty-print
            try {
                const parsed = JSON.parse(s);
                return JSON.stringify(parsed, null, 2);
            } catch (_) {
                // Fallback: simple pretty printer for single-line JSON-like strings
                return simplePretty(s);
            }
        } catch (e) {
            return jsonStr;
        }
    }

    function simplePretty(s) {
        // Basic character-wise pretty printer that inserts newlines and indentation
        let out = '';
        let indent = 0;
        const indentStr = () => '  '.repeat(indent);
        for (let i = 0; i < s.length; i++) {
            const ch = s[i];
            if (ch === '{' || ch === '[') {
                out += ch + '\n';
                indent++;
                out += indentStr();
            } else if (ch === '}' || ch === ']') {
                out += '\n';
                indent = Math.max(0, indent - 1);
                out += indentStr() + ch;
            } else if (ch === ',') {
                out += ch + '\n' + indentStr();
            } else {
                out += ch;
            }
        }
        return out;
    }

    let lastShownPT = null;

    function showTraceDetail(pt) {
        // entferne vorherige Markierung
        const prev = lastShownPT;
        if (prev && prev.id) {
            const prevEl = document.getElementById('pt-' + prev.id);
            if (prevEl) prevEl.classList.remove('selected');
        }

        // setze neuen selection state
        lastShownPT = pt;
        const li = document.getElementById('pt-' + pt.id);
        if (li) {
            li.classList.add('selected');
            try {
                li.scrollIntoView({behavior: 'smooth', block: 'nearest', inline: 'nearest'});
            } catch (e) {
            }
        }

        // existing detail rendering (unverÃ¤ndert; nur in Funktion erhalten)
        const detail = document.getElementById('traceDetail');
        try {
            const isRaw = document.getElementById('eebusJsonCheckbox') && document.getElementById('eebusJsonCheckbox').checked;
            let text = '';
            if (pt.rawJson) {
                const s = JSON.stringify(pt.rawJson);
                text = isRaw ? JSON.stringify(pt.rawJson, null, 2) : eebusJsonToJson(s);
            } else {
                text = pt.rawLine || '';
            }
            detail.textContent = text;
        } catch (e) {
            detail.textContent = pt.rawLine || '';
        }
        detail.style.display = 'block';
        const closeBtn = document.getElementById('traceDetailClose');
        if (closeBtn) closeBtn.style.display = 'inline-block';
        detail.scrollTop = 0;

        // scroll the detail panel into view so user clearly sees the detail area
        const panel = document.getElementById('traceDetailPanel');
        if (panel) {
            try {
                panel.scrollIntoView({behavior: 'smooth', block: 'start'});
            } catch (e) {
            }
        }
    }

    // Update displayed detail when checkbox changes
    const eebusCheckbox = document.getElementById('eebusJsonCheckbox');
    if (eebusCheckbox) {
        eebusCheckbox.addEventListener('change', () => {
            if (lastShownPT) showTraceDetail(lastShownPT);
        });
    }

    const traceDetailCloseBtn = document.getElementById('traceDetailClose');
    if (traceDetailCloseBtn) {
        traceDetailCloseBtn.addEventListener('click', function () {
            const detail = document.getElementById('traceDetail');
            if (detail) detail.style.display = 'none';
            this.style.display = 'none';
        });
    }

    const clearParsedBtn = document.getElementById('clearParsed');
    if (clearParsedBtn) {
        clearParsedBtn.addEventListener('click', clearParsedTraces);
    }

    // WebSocket for logs and usecase updates
    (function () {
        const logsEl = document.getElementById('logs');
        const logsBtn = document.getElementById('logsToBottomBtn');
        const protocol = (location.protocol === 'https:') ? 'wss:' : 'ws:';
        const wsUrl = protocol + '//' + location.host + '/ws/logs';
        let ws;
        // auto-scroll state: true means keep scrolling to newest messages
        let logsAutoScroll = true;

        function updateLogsButton() {
            if (!logsBtn) return;
            logsBtn.style.display = logsAutoScroll ? 'none' : 'inline-block';
        }

        // clicking the button forces scroll to bottom and re-enables auto-scroll
        if (logsBtn) {
            logsBtn.addEventListener('click', () => {
                logsAutoScroll = true;
                try {
                    logsEl.scrollTop = logsEl.scrollHeight;
                } catch (e) {
                }
                updateLogsButton();
            });
        }

        // detect user scroll - if user scrolls up, disable auto-scroll; if they scroll to bottom, enable it
        if (logsEl) {
            logsEl.addEventListener('scroll', () => {
                const atBottom = (logsEl.scrollHeight - logsEl.scrollTop - logsEl.clientHeight) <= 8;
                logsAutoScroll = atBottom;
                updateLogsButton();
            });
        }

        function connect() {
            ws = new WebSocket(wsUrl);
            ws.addEventListener('open', () => {
                if (logsEl) logsEl.textContent = ''
            });
            ws.addEventListener('message', (ev) => {
                const line = (typeof ev.data === 'string') ? ev.data : JSON.stringify(ev.data);
                // First try: is this a structured usecase JSON message we previously used?
                let parsed = null;
                try {
                    parsed = JSON.parse(line)
                } catch (e) {
                    parsed = null
                }
                if (parsed && parsed.type === 'usecase') {
                    const name = parsed.name;
                    const supported = !!parsed.supported;
                    setUsecase(name, supported);
                    return;
                }
                if (parsed && parsed.type === 'entities') {
                    const arr = parsed.entities || [];
                    renderEntities(arr);
                    return;
                }

                // Detect TRACE Send/Recv lines and try to parse JSON inside them
                const isTrace = (typeof line === 'string') && (/TRACE\s*(Recv|Send)/i.test(line) || /Trace\s*(Recv|Send)/i.test(line));
                if (isTrace) {
                    const ts = extractTimestamp(line);
                    const direction = extractDirection(line);
                    const js = extractJsonString(line);
                    if (js) {
                        try {
                            const obj = JSON.parse(js);
                            const cmdClassifier = findValueByKey(obj, 'cmdClassifier') || '';
                            const cmdType = findCmdType(obj) || '';
                            addParsedTrace({
                                ts: ts,
                                direction: direction,
                                cmdClassifier: cmdClassifier,
                                cmdType: cmdType,
                                rawJson: obj,
                                rawLine: line
                            });
                            return
                        } catch (e) { /* fallthrough to log */
                        }
                    }
                }

                // fallback: treat as plain log line
                if (logsEl) {
                    if (logsEl.textContent && logsEl.textContent.length > 0) {
                        logsEl.textContent += '\n' + line
                    } else {
                        logsEl.textContent = line
                    }
                }
                // only auto-scroll when enabled
                if (logsAutoScroll && logsEl) {
                    try {
                        logsEl.scrollTop = logsEl.scrollHeight;
                    } catch (e) {
                    }
                }
            });
            ws.addEventListener('close', () => {
                setTimeout(connect, 1000)
            });
            ws.addEventListener('error', (e) => {
                console.error('ws error', e);
                try {
                    ws.close()
                } catch (_) {
                }
            });
        }

        connect();
    })();

    // Build API payloads for new endpoints
    async function apiWrite(payload) {
        try {
            const res = await fetch('/api/write', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const txt = await res.text();
            if (!res.ok) {
                alert('Write failed: ' + txt)
            }
        } catch (err) {
            alert('Request failed: ' + err)
        }
    }

    // wire up control buttons and polling of usecaseData
    document.addEventListener('DOMContentLoaded', () => {
        // sanitize duration inputs to integers where required
        intInputSanitize(document.getElementById('writeLimitDurationSec'));
        intInputSanitize(document.getElementById('writeFailsafeDurationMin'));

        const sendWriteLimitBtn = document.getElementById('sendWriteLimit');
        if (sendWriteLimitBtn) {
            sendWriteLimitBtn.addEventListener('click', () => {
                const val = parseFloat((document.getElementById('writeLimitValue') || {}).value) || 0;
                const dur = parseInt((document.getElementById('writeLimitDurationSec') || {}).value, 10) || 0;
                const active = !!(document.getElementById('writeLimitActive') && document.getElementById('writeLimitActive').checked);
                apiWrite({cmd: 'writeLPCConsumptionLimit', durationSeconds: dur, value: val, isActive: active});
            });
        }

        const sendFailsafePower = document.getElementById('sendWriteFailsafePower');
        if (sendFailsafePower) {
            sendFailsafePower.addEventListener('click', () => {
                const p = parseFloat((document.getElementById('writeFailsafePower') || {}).value) || 0;
                apiWrite({cmd: 'writeLPCFailsafeValue', failsafePower: p});
            });
        }

        const sendFailsafeDur = document.getElementById('sendWriteFailsafeDuration');
        if (sendFailsafeDur) {
            sendFailsafeDur.addEventListener('click', () => {
                const m = parseInt((document.getElementById('writeFailsafeDurationMin') || {}).value, 10) || 0;
                apiWrite({cmd: 'writeLPCFailsafeDuration', durationMinutes: m});
            });
        }

        // LPP write handlers
        const sendWriteLppLimitBtn = document.getElementById('sendWriteLppLimit');
        if (sendWriteLppLimitBtn) {
            sendWriteLppLimitBtn.addEventListener('click', () => {
                const val = parseFloat((document.getElementById('writeLppLimitValue') || {}).value) || 0;
                const dur = parseInt((document.getElementById('writeLppLimitDurationSec') || {}).value, 10) || 0;
                const active = !!(document.getElementById('writeLppLimitActive') && document.getElementById('writeLppLimitActive').checked);
                apiWrite({cmd: 'writeLPPProductionLimit', durationSeconds: dur, value: val, isActive: active});
            });
        }

        const sendLppFailsafePower = document.getElementById('sendWriteLppFailsafePower');
        if (sendLppFailsafePower) {
            sendLppFailsafePower.addEventListener('click', () => {
                const p = parseFloat((document.getElementById('writeLppFailsafePower') || {}).value) || 0;
                apiWrite({cmd: 'writeLPPFailsafeValue', failsafePower: p});
            });
        }

        const sendLppFailsafeDur = document.getElementById('sendWriteLppFailsafeDuration');
        if (sendLppFailsafeDur) {
            sendLppFailsafeDur.addEventListener('click', () => {
                const m = parseInt((document.getElementById('writeLppFailsafeDurationMin') || {}).value, 10) || 0;
                apiWrite({cmd: 'writeLPPFailsafeDuration', durationMinutes: m});
            });
        }

        // OSCEV write handlers
        const sendWriteOscevLimitBtn = document.getElementById('sendWriteOscevLimit');
        if (sendWriteOscevLimitBtn) {
            sendWriteOscevLimitBtn.addEventListener('click', () => {
                const val = parseFloat((document.getElementById('writeOscevLimitValue') || {}).value) || 0;
                const active = !!(document.getElementById('writeOscevLimitActive') && document.getElementById('writeOscevLimitActive').checked);
                apiWrite({cmd: 'writeOSCEVLoadControlLimits', value: val, isActive: active});
            });
        }

        // initial poll
        fetchUsecaseData();
        loadUsecases();
        loadEntities();

        // poll periodically for usecaseData so frontend shows latest values
        setInterval(fetchUsecaseData, 2000);
    });

    async function fetchUsecaseData() {
        try {
            const res = await fetch('/api/usecasedata');
            if (!res.ok) return;
            const d = await res.json();
            /*
            // update LPC
           const lpcVal = (d.lpcLimitValue !== undefined) ? d.lpcLimitValue : '-';
            document.getElementById('lpcLimitValue').textContent = lpcVal;
            document.getElementById('lpcLimitDur').textContent = (d.lpcLimitDurationSec !== undefined) ? d.lpcLimitDurationSec : '-';
            document.getElementById('lpcLimitActive').textContent = (d.lpcLimitActive !== undefined) ? (d.lpcLimitActive ? 'yes' : 'no') : '-';
            document.getElementById('failsafePower').textContent = (d.lpcFailsafePower !== undefined) ? d.lpcFailsafePower : '-';
            document.getElementById('failsafeDuration').textContent = (d.lpcFailsafeDurationMin !== undefined) ? d.lpcFailsafeDurationMin : '-';
            // update LPP explicit fields only when supported
            if (lppSupported) {
                const setText = (id, v) => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = (v !== undefined ? v : '-');
                };
                setText('lppFailsafeValue', d.lppFailsafeValue);
                setText('lppFailsafeDur', d.lppFailsafeDurationSec);
                setText('lppLimitValue', d.lppLimitValue);
                setText('lppLimitDur', d.lppLimitDurationSec);
                setText('lppLimitActive', (d.lppLimitActive !== undefined) ? (d.lppLimitActive ? 'yes' : 'no') : '-');
            }*/
        } catch (e) {
            // ignore
        }
    }


    // display flags for features
    let lppSupported = false, lpcSupported = false, evseccSupported = false, evccSupported = false,
        evcemSupported = false, opevSupported = false, oscevSupported = false, evsocSupported = false,
        cevcSupported = false, mpcSupported = false;

    // Generic function to update usecase display using new Badge/Content pattern
    function updateUsecaseDisplay(name, supported) {
        const badge = document.getElementById(name + 'Badge');
        const content = document.getElementById(name + 'Content');
        if (badge) {
            badge.textContent = supported ? 'supported' : 'not supported';
            badge.className = 'support-badge ' + (supported ? 'supported' : 'unsupported');
        }
        if (content) {
            if (supported) {
                content.classList.remove('disabled');
            } else {
                content.classList.add('disabled');
            }
        }
    }

    const originalSetUsecase = setUsecase;
    setUsecase = function (name, supported) {
        originalSetUsecase(name, supported);
        try {
            const n = String(name || '').trim().toLowerCase();
            // Update the supported flag variable
            if (n === 'lpp') lppSupported = supported;
            else if (n === 'lpc') lpcSupported = supported;
            else if (n === 'evsecc') evseccSupported = supported;
            else if (n === 'evcc') evccSupported = supported;
            else if (n === 'evcem') evcemSupported = supported;
            else if (n === 'opev') opevSupported = supported;
            else if (n === 'oscev') oscevSupported = supported;
            else if (n === 'evsoc') evsocSupported = supported;
            else if (n === 'cevc') cevcSupported = supported;
            else if (n === 'mpc') mpcSupported = supported;
            // Update the display using the generic function
            updateUsecaseDisplay(n, supported);
        } catch (e) {
        }
    }

    // initialize default (disabled) state until usecases loaded
    document.addEventListener('DOMContentLoaded', () => {
        ['lpp', 'lpc', 'evsecc', 'evcc', 'evcem', 'opev', 'oscev', 'evsoc', 'cevc', 'mpc'].forEach(uc => {
            updateUsecaseDisplay(uc, false);
        });
    });

    // adjust fetchUsecaseData to only update LPP fields when supported
    const originalFetchLPP = fetchUsecaseData;
    fetchUsecaseData = async function () {
        try {
            const res = await fetch('/api/usecasedata');
            if (!res.ok) return;
            const d = await res.json();
            const fallback = v => (v !== undefined ? v : '-');

            const setText = (id, v) => {
                console.log('Updating %s to %s', id, v);
                const el = document.getElementById(id);
                if (!el) return;
                const newText = String(fallback(v));
                if (el.textContent !== newText) {
                    el.textContent = newText;
                    flashElement(el);
                } else {
                    el.textContent = newText;
                }
            };
            const setManufacturer = (id, data) => {
                const el = document.getElementById(id);
                if (el && data !== undefined) {
                    const newHtml = `<div style="min-width:80px"><div style="font-size:12px;color:var(--muted)">Device Name</div><div style="font-weight:600">${fallback(data.DeviceName)}</div></div>\n` +
                        `<div style="min-width:80px"><div style="font-size:12px;color:var(--muted)">Device Code</div><div style="font-weight:600">${fallback(data.DeviceCode)}</div></div>\n` +
                        `<div style="min-width:80px"><div style="font-size:12px;color:var(--muted)">Serial Number</div><div style="font-weight:600">${fallback(data.SerialNumber)}</div></div>\n` +
                        `<div style="min-width:80px"><div style="font-size:12px;color:var(--muted)">Software Revision</div><div style="font-weight:600">${fallback(data.SoftwareRevision)}</div></div>\n` +
                        `<div style="min-width:80px"><div style="font-size:12px;color:var(--muted)">Hardware Revision</div><div style="font-weight:600">${fallback(data.HardwareRevision)}</div></div>\n` +
                        `<div style="min-width:80px"><div style="font-size:12px;color:var(--muted)">Vendor Name</div><div style="font-weight:600">${fallback(data.VendorName)}</div></div>\n` +
                        `<div style="min-width:80px"><div style="font-size:12px;color:var(--muted)">Vendor Code</div><div style="font-weight:600">${fallback(data.VendorCode)}</div></div>\n` +
                        `<div style="min-width:80px"><div style="font-size:12px;color:var(--muted)">Brand Name</div><div style="font-weight:600">${fallback(data.BrandName)}</div></div>\n` +
                        `<div style="min-width:80px"><div style="font-size:12px;color:var(--muted)">Power Source</div><div style="font-weight:600">${fallback(data.PowerSource)}</div></div>\n` +
                        `<div style="min-width:80px"><div style="font-size:12px;color:var(--muted)">Manufacturer Node ID</div><div style="font-weight:600">${fallback(data.ManufacturerNodeIdentification)}</div></div>\n` +
                        `<div style="min-width:80px"><div style="font-size:12px;color:var(--muted)">Manufacturer Label</div><div style="font-weight:600">${fallback(data.ManufacturerLabel)}</div></div>\n` +
                        `<div style="min-width:80px"><div style="font-size:12px;color:var(--muted)">Manufacturer Description</div><div style="font-weight:600">${fallback(data.ManufacturerDescription)}</div></div>`;
                    if (el.innerHTML !== newHtml) {
                        el.innerHTML = newHtml;
                        flashElement(el);
                    } else {
                        el.innerHTML = newHtml;
                    }
                }
            }
            // update LPC
            if (lpcSupported) {
                setText('lpcLimitValue', d.lpcLimitValue);
                setText('lpcLimitDur', d.lpcLimitDurSeconds);
                setText('lpcLimitActive', d.lpcLimitActive);
                setText('lpcFailsafePower', d.lpcFailsafePower);
                setText('lpcFailsafeDuration', d.lpcFailsafeDurMinutes);
                setText('lpcMaxNominalPower', d.lpcConsumptionLimitNominalMax)
                setText('lpcHeartbeat', d.lpcHeartbeatOk)
                setText('lpcHeartbeatTimestamp', d.lpcHeartbeatTimestamp)
            }
            if (lppSupported) {
                // update LPP explicit fields only when supported
                setText('lppFailsafeValue', d.lppFailsafeValue);
                setText('lppFailsafeDur', d.lppFailsafeDurMinutes);
                setText('lppLimitValue', d.lppLimitValue);
                setText('lppLimitDur', d.lppLimitDurationSeconds);
                setText('lppLimitActive', (d.lppLimitActive !== undefined) ? (d.lppLimitActive ? 'yes' : 'no') : '-');
            }
            if (evseccSupported) {
                setManufacturer('evseccManufacturer', d.evseccManufacturerData);
                setText('evseccOperatingState', d.evseccOperatingState);
                setText('evseccErrorMessage', d.evseccOperatingStateDescription);
            }
            if (evccSupported) {
                setManufacturer('evccManufacturer', d.evccManufacturerData);
                setText('evccEvConnected', d.evccEvConnected);
                setText('evccCommStandard', d.evccCommunicationStandard);
                setText('evccAsymmetricCharging', d.evccAsymmetricChargingSupport);
                setText('evccChargingLimitsMin', d.evccLimitMinimum);
                setText('evccChargingLimitsMax', d.evccLimitMaximum);
                setText('evccChargingLimitsStandy', d.evccLimitStandby);
                setText('evccSleepMode', d.evccSleepMode);
                if (d.evccIdentifications && Array.isArray(d.evccIdentifications) && d.evccIdentifications.length > 0) {
                    setText('evccIdentificationType', d.evccIdentifications[0].ValueType);
                    setText('evccIdentificationValue', d.evccIdentifications[0].Value);
                } else {
                    setText('evccIdentificationType', '-');
                    setText('evccIdentificationValue', '-');
                }
            }
            if(evcemSupported) {
                setText('evcemChargingCurrent', d.evcemCurrentPerPhase);
                setText('evcemChargingPower', d.evcemPowerPerPhase);
                setText('evcemChargedEnergy', d.evcemEnergyCharged);
            }
            if (opevSupported) {
                // Format load control limits - each has Value, IsActive, Phase
                const formatLoadLimits = (limits) => {
                    if (!limits || !Array.isArray(limits) || limits.length === 0) return '-';
                    return limits.map(l => {
                        const phase = l.Phase !== undefined ? `P${l.Phase}` : '';
                        const val = l.Value !== undefined ? l.Value : '-';
                        const active = l.IsActive ? ' (active)' : ' (inactive)';
                        return `${phase}: ${val}A${active}`;
                    }).join(', ');
                };
                // Format current limits array (simple float arrays per phase)
                const formatCurrentArray = (arr) => {
                    if (!arr || !Array.isArray(arr) || arr.length === 0) return '-';
                    return arr.map((v, i) => `P${i + 1}: ${v}A`).join(', ');
                };
                setText('opevLoadLimit', formatLoadLimits(d.opevLoadControlLimit));
                setText('opevCurrentLimitMin', formatCurrentArray(d.opevCurrentLimitMin));
                setText('opevCurrentLimitMax', formatCurrentArray(d.opevCurrentLimitMax));
                setText('opevCurrentLimitDefault', formatCurrentArray(d.opevCurrentLimitDefault));
            }
            if (oscevSupported) {
                // Format load control limits - each has Value, IsActive, Phase
                const formatLoadLimits = (limits) => {
                    if (!limits || !Array.isArray(limits) || limits.length === 0) return '-';
                    return limits.map(l => {
                        const phase = l.Phase !== undefined ? `P${l.Phase}` : '';
                        const val = l.Value !== undefined ? l.Value : '-';
                        const active = l.IsActive ? ' (active)' : ' (inactive)';
                        return `${phase}: ${val}A${active}`;
                    }).join(', ');
                };
                // Format current limits array (simple float arrays per phase)
                const formatCurrentArray = (arr) => {
                    if (!arr || !Array.isArray(arr) || arr.length === 0) return '-';
                    return arr.map((v, i) => `P${i + 1}: ${v}A`).join(', ');
                };
                setText('oscevLoadLimit', formatLoadLimits(d.oscevLoadControlLimit));
                setText('oscevCurrentLimitMin', formatCurrentArray(d.oscevCurrentLimitMin));
                setText('oscevCurrentLimitMax', formatCurrentArray(d.oscevCurrentLimitMax));
                setText('oscevCurrentLimitDefault', formatCurrentArray(d.oscevCurrentLimitDefault));
            }
            if (evsocSupported) {
                setText('evsocStateOfCharge', d.evsocStateOfCharge !== undefined ? d.evsocStateOfCharge.toFixed(1) : '-');
            }
            if (cevcSupported) {
                setText('cevcChargeStrategy', d.cevcChargeStrategy);
                // Energy demand fields
                if (d.cevcEnergyDemand) {
                    setText('cevcMinDemand', d.cevcEnergyDemand.MinDemand);
                    setText('cevcOptDemand', d.cevcEnergyDemand.OptDemand);
                    setText('cevcMaxDemand', d.cevcEnergyDemand.MaxDemand);
                    setText('cevcDurationStart', d.cevcEnergyDemand.DurationUntilStart);
                    setText('cevcDurationEnd', d.cevcEnergyDemand.DurationUntilEnd);
                }
                // Format charge plan slots
                if (d.cevcChargePlan && d.cevcChargePlan.Slots && Array.isArray(d.cevcChargePlan.Slots)) {
                    const planText = d.cevcChargePlan.Slots.map((slot, i) => {
                        const start = slot.Start || 0;
                        const end = slot.End || 0;
                        const minPower = slot.MinPower !== undefined ? slot.MinPower : '-';
                        const maxPower = slot.MaxPower !== undefined ? slot.MaxPower : '-';
                        const minEnergy = slot.MinEnergy !== undefined ? slot.MinEnergy : '-';
                        const maxEnergy = slot.MaxEnergy !== undefined ? slot.MaxEnergy : '-';
                        return `Slot ${i + 1}: ${start}s - ${end}s | Power: ${minPower}W - ${maxPower}W | Energy: ${minEnergy}Wh - ${maxEnergy}Wh`;
                    }).join('\n');
                    setText('cevcChargePlan', planText || '-');
                } else {
                    setText('cevcChargePlan', '-');
                }
            }
            if (mpcSupported) {
                setText('mpcPower', d.mpcPower);
                // Format per-phase arrays
                const formatPhaseArray = (arr, unit) => {
                    if (!arr || !Array.isArray(arr) || arr.length === 0) return '-';
                    return arr.map((v, i) => `P${i + 1}: ${v}${unit}`).join(', ');
                };
                setText('mpcPowerPerPhase', formatPhaseArray(d.mpcPowerPerPhase, 'W'));
                setText('mpcCurrentPerPhase', formatPhaseArray(d.mpcCurrentPerPhase, 'A'));
                setText('mpcVoltagePerPhase', formatPhaseArray(d.mpcVoltagePerPhase, 'V'));
                setText('mpcFrequency', d.mpcFrequency);
                setText('mpcEnergyConsumed', d.mpcEnergyConsumed);
                setText('mpcEnergyProduced', d.mpcEnergyProduced);
            }

        } catch (e) {
            // ignore
        }
    }
</script>
</body>
</html>
