<!doctype html>
<html lang="de">
<head>
    <meta charset="utf-8"/>
    <title>EEBUS Device Tester</title>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <style>
        :root {
            --bg: #f6f8fa;
            --card: #ffffff;
            --muted: #6b7280;
            --accent: #2563eb;
            --success: #059669;
            --danger: #ef4444;
            --code-bg: #111;
            --code-color: #bada55;
        }

        html, body {
            height: 100%;
            margin: 0;
            background: var(--bg);
            font-family: Inter, Roboto, Arial, sans-serif;
            color: #111
        }

        .app {
            display: flex;
            flex-direction: column;
            height: 100vh;
            gap: 12px;
            padding: 12px;
            box-sizing: border-box;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        h1 {
            font-size: 20px;
            margin: 0
        }

        h5 {
            margin: 10px 0 2px 0;
            display: block;
            width: 100%;
            border-bottom: 1px solid rgba(0, 0, 0, 0.2);
        }

        .card {
            background: var(--card);
            border-radius: 8px;
            box-shadow: 0 1px 2px rgba(16, 24, 40, 0.03);
            padding: 12px;
        }

        .field-row {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 6px
        }

        label {
            color: var(--muted);
            font-size: 13px
        }

        .usecase-label {
            font-weight: 600;
        }

        .usecase-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .usecase-header .usecase-label {
            font-weight: 600;
            font-size: 14px;
        }

        .support-badge {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
        }

        .support-badge.supported {
            background: #d1fae5;
            color: #065f46;
        }

        .support-badge.unsupported {
            background: #f3f4f6;
            color: #6b7280;
        }

        .usecase-content {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .usecase-content.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .usecase-content.disabled input,
        .usecase-content.disabled button {
            pointer-events: none;
        }

        .data-label {
            font-size: 12px;
            color: var(--muted);
        }

        .data-container {
            min-width: 80px;
        }

        .data-value {
            font-weight: 600;
            font-size: 13px;
        }

        input[type="text"], input[type="number"], select {
            padding: 6px 8px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            width: 100%;
            box-sizing: border-box;
        }

        button {
            background: var(--accent);
            color: white;
            border: 0;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer
        }

        button.secondary {
            background: #e5e7eb;
            color: #111
        }

        /* ========== PEER TABS ========== */
        .peer-tabs-container {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
            gap: 8px;
        }

        .peer-tabs-bar {
            display: flex;
            gap: 2px;
            border-bottom: 1px solid #ccc;
            overflow-x: auto;
            overflow-y: hidden;
            padding: 4px 4px 0 4px;
            background: #f1f1f1;
            border-radius: 8px 8px 0 0;
            flex-shrink: 0;
        }

        .peer-tab {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: #e5e7eb;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: #374151;
            white-space: nowrap;
            transition: background-color 0.2s;
        }

        .peer-tab:hover {
            background: #d1d5db;
        }

        .peer-tab.active {
            background: #ffffff;
            color: #111;
            border-bottom: 2px solid var(--accent);
        }

        .peer-tab .close-btn {
            background: transparent;
            border: none;
            color: #6b7280;
            cursor: pointer;
            font-size: 14px;
            padding: 0;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 3px;
        }

        .peer-tab .close-btn:hover {
            background: rgba(0, 0, 0, 0.1);
            color: #111;
        }

        .peer-tab .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        .peer-tab .status-dot.connected {
            background: var(--success);
        }

        .peer-tab .status-dot.disconnected {
            background: var(--danger);
        }

        .peer-tab-content {
            display: none;
            flex: 1;
            overflow: auto;
            min-height: 0;
        }

        .peer-tab-content.active {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* Peers List Table */
        .peers-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .peers-table th,
        .peers-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .peers-table th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
        }

        .peers-table tr:hover {
            background: #f9fafb;
        }

        .peers-table .status-connected {
            color: var(--success);
            font-weight: 600;
        }

        .peers-table .status-disconnected {
            color: var(--danger);
        }

        .peers-table .ski-cell {
            font-family: monospace;
            font-size: 12px;
            color: #6b7280;
        }

        .peers-table button {
            padding: 4px 10px;
            font-size: 12px;
        }

        .peers-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .peers-list-header h3 {
            margin: 0;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--muted);
        }

        /* Peer content layout */
        .peer-content-layout {
            display: flex;
            gap: 12px;
            flex: 1;
            min-height: 0;
            overflow: auto;
        }

        .peer-content-left {
            width: 440px;
            min-width: 440px;
            max-width: 620px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .peer-content-right {
            flex: 1;
            min-width: 200px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* Sub tabs */
        .sub-tabs {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
            display: flex;
        }

        .sub-tabs button {
            background-color: inherit;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 10px 16px;
            transition: 0.3s;
            color: black;
            font-size: 13px;
        }

        .sub-tabs button:hover {
            background-color: #ddd;
        }

        .sub-tabs button.active {
            background-color: #ccc;
        }

        .subtab-content {
            display: none;
            padding: 6px 12px;
            border: 1px solid #ccc;
            border-top: none;
            flex: 1;
            overflow: auto;
            min-height: 0;
        }

        .subtab-content.active {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* Trace list styles */
        .parsed-traces-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 4px;
            overflow: auto;
        }

        .parsed-traces-list li {
            padding: 6px 8px;
            margin: 4px 0;
            border-radius: 6px;
            display: flex;
            gap: 8px;
            align-items: center;
            cursor: pointer;
            background: #fff;
            box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.02) inset;
            font-size: 13px;
            line-height: 18px;
        }

        .parsed-traces-list li.selected {
            background: #e8f0ff;
            box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.12) inset;
        }

        .trace-ts {
            color: var(--muted);
            width: 150px;
        }

        .dir-recv {
            color: var(--accent);
            font-weight: 700;
        }

        .dir-send {
            color: purple;
            font-weight: 700;
        }

        /* Entities tree */
        .entities-list {
            list-style: none;
            padding: 0;
            margin: 0;
            border: 1px solid #eef2ff;
            border-radius: 6px;
        }

        .entities-list li {
            padding: 8px;
            border-bottom: 1px solid #f1f5f9;
        }

        .tree-toggle {
            display: inline-block;
            width: 18px;
            text-align: center;
            color: var(--muted);
            cursor: pointer;
        }

        .entity-addr {
            font-weight: 600;
            cursor: pointer;
        }

        /* Trace detail */
        .trace-detail {
            display: none;
            white-space: pre-wrap;
            background: #0b1220;
            color: #dbeafe;
            padding: 12px;
            border-radius: 6px;
            overflow: auto;
            flex: 1;
            max-height: 50%;
            min-height: 0;
            font-family: monospace;
            font-size: 12px;
        }

        /* Logs */
        .peer-logs {
            white-space: pre-wrap;
            background: #0b1220;
            color: #dbeafe;
            padding: 10px;
            height: 240px;
            overflow: auto;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
        }

        @media (max-width: 900px) {
            .peer-content-layout {
                flex-direction: column;
            }
            .peer-content-left {
                width: 100%;
                min-width: auto;
            }
        }
    </style>
</head>
<body>
<div class="app">
    <header>
        <h1>EEBUS Device Tester</h1>
        <div style="color:var(--muted);font-size:13px">Multi-Peer Support</div>
    </header>

    <!-- Peer Tabs Container -->
    <div class="peer-tabs-container">
        <!-- Tab Bar -->
        <div class="peer-tabs-bar" id="peerTabsBar">
            <button class="peer-tab active" data-tab="peers-list" onclick="switchPeerTab('peers-list')">
                <span>Peers List</span>
            </button>
        </div>

        <!-- Peers List Tab Content -->
        <div class="peer-tab-content active" id="tab-peers-list">
            <div class="card">
                <div class="peers-list-header">
                    <h3 style="margin:0">Discovered Peers</h3>
                    <div style="color:var(--muted);font-size:13px" id="peersCount">Loading...</div>
                </div>
                <table class="peers-table">
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>SKI</th>
                            <th>Device Info</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="peersTableBody">
                        <tr>
                            <td colspan="4" style="text-align:center;padding:40px;color:var(--muted)">
                                Loading peers...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Templates for peer tabs (hidden, cloned dynamically) -->
    <template id="peerTabTemplate">
        <button class="peer-tab" data-tab="">
            <span class="status-dot"></span>
            <span class="tab-label"></span>
            <span class="close-btn" title="Close tab">&times;</span>
        </button>
    </template>

    <template id="peerContentTemplate">
        <div class="peer-tab-content">
            <div class="peer-content-layout">
                <!-- Left Column: Data and Control + Entities -->
                <div class="peer-content-left">
                    <!-- Data and Control Panel -->
                    <section class="card" style="padding:12px;flex:1;overflow:auto">
                        <h3 style="margin:0 0 6px 0">Data and Control</h3>
                        <div class="peer-ski-display" style="color:var(--muted);font-size:12px;margin-bottom:10px"></div>

                        <div style="display:flex;flex-direction:column;gap:8px">
                            <!-- LPC-->
                            <div class="usecase-header">
                                <div class="usecase-label">LPC</div>
                                <span class="support-badge unsupported lpc-badge">not supported</span>
                            </div>
                            <div class="usecase-content disabled lpc-content">
                                <h5>Scenario 1 - Control active power consumption</h5>
                                <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                                    <div class="data-container">
                                        <div class="data-label">Limit (W)</div>
                                        <div class="data-value lpc-limit-value">-</div>
                                    </div>
                                    <div class="data-container">
                                        <div class="data-label">Duration (s)</div>
                                        <div class="data-value lpc-limit-dur">-</div>
                                    </div>
                                    <div class="data-container">
                                        <div class="data-label">Active</div>
                                        <div class="data-value lpc-limit-active">-</div>
                                    </div>
                                </div>
                                <div style="display:flex; gap:8px; align-items:center;">
                                    <input class="write-limit-value" type="number" placeholder="value (W)" style="width:90px" value="3600"/>
                                    <input class="write-limit-duration" type="number" placeholder="duration (s)" style="width:90px" value="600"/>
                                    <label style="display:flex;align-items:center;gap:6px;margin:0"><input class="write-limit-active" type="checkbox" checked/> Active</label>
                                    <button class="send-write-limit">Send Loadcontrol Limit</button>
                                </div>
                                <h5>Scenario 2 - Failsafe</h5>
                                <div style="display:flex; gap:8px; align-items:center; margin-top:8px;">
                                    <div class="data-container">
                                        <div class="data-label">Failsafe Power (W)</div>
                                        <div class="data-value lpc-failsafe-power">-</div>
                                    </div>
                                    <div class="data-container">
                                        <div class="data-label">Failsafe Duration (min)</div>
                                        <div class="data-value lpc-failsafe-duration">-</div>
                                    </div>
                                </div>
                                <div style="display:flex; gap:8px; align-items:center; margin-top:6px;">
                                    <input class="write-failsafe-power" type="number" placeholder="failsafe power (W)" style="width:120px" value="2500"/>
                                    <input class="write-failsafe-duration" type="number" placeholder="duration (min)" style="width:120px" value="300"/>
                                    <button class="send-write-failsafe-power">Send Failsafe Power</button>
                                    <button class="send-write-failsafe-duration">Send Failsafe Duration</button>
                                </div>
                                <h5>Scenario 3 - Heartbeat</h5>
                                <div style="display:flex; gap:8px; align-items:center; margin-top:8px;">
                                    <div class="data-container">
                                        <div class="data-label">Heartbeat Received</div>
                                        <div class="data-value lpc-heartbeat">-</div>
                                    </div>
                                    <div class="data-container">
                                        <div class="data-label">Last Heartbeat Time</div>
                                        <div class="data-value lpc-heartbeat-timestamp">-</div>
                                    </div>
                                </div>
                                <h5>Scenario 4 - Constraints</h5>
                                <div style="display:flex; gap:8px; align-items:center; margin-top:8px;">
                                    <div class="data-container">
                                        <div class="data-label">Maximum possible Power Consumption (W)</div>
                                        <div class="data-value lpc-max-nominal-power">-</div>
                                    </div>
                                </div>
                            </div>

                            <div style="height:1px;background:grey;margin:6px 0"></div>
                            <!-- LPP-->
                            <div class="usecase-header">
                                <div class="usecase-label">LPP</div>
                                <span class="support-badge unsupported lpp-badge">not supported</span>
                            </div>
                            <div class="usecase-content disabled lpp-content">
                                <h5>Scenario 1 - Control active power production</h5>
                                <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                                    <div class="data-container">
                                        <div class="data-label">Limit (W)</div>
                                        <div class="data-value lpp-limit-value">-</div>
                                    </div>
                                    <div class="data-container">
                                        <div class="data-label">Duration (s)</div>
                                        <div class="data-value lpp-limit-dur">-</div>
                                    </div>
                                    <div class="data-container">
                                        <div class="data-label">Active</div>
                                        <div class="data-value lpp-limit-active">-</div>
                                    </div>
                                </div>
                                <div style="display:flex; gap:8px; align-items:center;">
                                    <input class="write-lpp-limit-value" type="number" placeholder="value (W)" style="width:90px" value="3600"/>
                                    <input class="write-lpp-limit-duration" type="number" placeholder="duration (s)" style="width:90px" value="600"/>
                                    <label style="display:flex;align-items:center;gap:6px;margin:0"><input class="write-lpp-limit-active" type="checkbox" checked/> Active</label>
                                    <button class="send-write-lpp-limit">Send Production Limit</button>
                                </div>
                                <h5>Scenario 2 - Failsafe</h5>
                                <div style="display:flex; gap:8px; align-items:center; margin-top:8px;">
                                    <div class="data-container">
                                        <div class="data-label">Failsafe Power (W)</div>
                                        <div class="data-value lpp-failsafe-value">-</div>
                                    </div>
                                    <div class="data-container">
                                        <div class="data-label">Failsafe Duration (min)</div>
                                        <div class="data-value lpp-failsafe-dur">-</div>
                                    </div>
                                </div>
                                <div style="display:flex; gap:8px; align-items:center; margin-top:6px;">
                                    <input class="write-lpp-failsafe-power" type="number" placeholder="failsafe power (W)" style="width:120px" value="2500"/>
                                    <input class="write-lpp-failsafe-duration" type="number" placeholder="duration (min)" style="width:120px" value="300"/>
                                    <button class="send-write-lpp-failsafe-power">Send Failsafe Power</button>
                                    <button class="send-write-lpp-failsafe-duration">Send Failsafe Duration</button>
                                </div>
                                <h5>Scenario 3 - Heartbeat</h5>
                                <div style="display:flex; gap:8px; align-items:center; margin-top:8px;">
                                    <div class="data-container">
                                        <div class="data-label">Heartbeat Received</div>
                                        <div class="data-value lpp-heartbeat">-</div>
                                    </div>
                                    <div class="data-container">
                                        <div class="data-label">Last Heartbeat Time</div>
                                        <div class="data-value lpp-heartbeat-timestamp">-</div>
                                    </div>
                                </div>
                            </div>
                            <div style="height:1px;background:grey;margin:6px 0"></div>

                            <!-- EVSECC-->
                            <div class="usecase-header">
                                <div class="usecase-label">EVSECC</div>
                                <span class="support-badge unsupported evsecc-badge">not supported</span>
                            </div>
                            <div class="usecase-content disabled evsecc-content">
                                <h5>Scenario 1 - EVSE sends manufacturer info</h5>
                                <div class="data-container">
                                    <div class="data-label">Manufacturer Data</div>
                                    <div class="data-value evsecc-manufacturer">-</div>
                                </div>
                                <h5>Scenario 2 - EVSE sends error state</h5>
                                <div style="display:flex; gap:8px; align-items:center; margin-top:8px;">
                                    <div class="data-container">
                                        <div class="data-label">Operating State</div>
                                        <div class="data-value evsecc-operating-state">-</div>
                                    </div>
                                    <div class="data-container">
                                        <div class="data-label">Error Message</div>
                                        <div class="data-value evsecc-error-message">-</div>
                                    </div>
                                </div>
                            </div>
                            <div style="height:1px;background:grey;margin:6px 0"></div>

                            <!-- EVCC-->
                            <div class="usecase-header">
                                <div class="usecase-label">EVCC</div>
                                <span class="support-badge unsupported evcc-badge">not supported</span>
                            </div>
                            <div class="usecase-content disabled evcc-content">
                                <h5>Scenario 1 - EV Connected</h5>
                                <div class="data-container">
                                    <div class="data-label">Operating State</div>
                                    <div class="data-value evcc-ev-connected">-</div>
                                </div>
                                <h5>Scenario 2 - Communication Standard</h5>
                                <div class="data-container">
                                    <div class="data-label">Communication Standard</div>
                                    <div class="data-value evcc-comm-standard">-</div>
                                </div>
                                <h5>Scenario 3 - Asymmetric Charging</h5>
                                <div class="data-container">
                                    <div class="data-label">Asymmetric Charging supported</div>
                                    <div class="data-value evcc-asymmetric-charging">-</div>
                                </div>
                                <h5>Scenario 4 - EV Identification</h5>
                                <div class="data-container">
                                    <div class="data-label">MAC type</div>
                                    <div class="data-value evcc-identification-type">-</div>
                                </div>
                                <div class="data-container">
                                    <div class="data-label">MAC Address</div>
                                    <div class="data-value evcc-identification-value">-</div>
                                </div>
                                <h5>Scenario 5 - Manufacturer</h5>
                                <div class="data-container">
                                    <div class="data-label">Manufacturer Data</div>
                                    <div class="data-value evcc-manufacturer">-</div>
                                </div>
                                <h5>Scenario 6 - Charging Power Limits</h5>
                                <div class="data-container">
                                    <div class="data-label">Minimum Charging Power (W)</div>
                                    <div class="data-value evcc-charging-limits-min">-</div>
                                </div>
                                <div class="data-container">
                                    <div class="data-label">Maximum Charging Power (W)</div>
                                    <div class="data-value evcc-charging-limits-max">-</div>
                                </div>
                                <div class="data-container">
                                    <div class="data-label">Standby Charging Power (W)</div>
                                    <div class="data-value evcc-charging-limits-standby">-</div>
                                </div>
                                <h5>Scenario 7 - Sleep Mode</h5>
                                <div class="data-container">
                                    <div class="data-label">EV Sleep Mode active</div>
                                    <div class="data-value evcc-sleep-mode">-</div>
                                </div>
                            </div>
                            <div style="height:1px;background:grey;margin:6px 0"></div>

                            <!-- EVCEM-->
                            <div class="usecase-header">
                                <div class="usecase-label">EVCEM</div>
                                <span class="support-badge unsupported evcem-badge">not supported</span>
                            </div>
                            <div class="usecase-content disabled evcem-content">
                                <h5>Scenario 1 - Charging Current</h5>
                                <div class="data-container">
                                    <div class="data-label">Charging Current per Phase (A)</div>
                                    <div class="data-value evcem-charging-current">-</div>
                                </div>
                                <h5>Scenario 2 - Charging Power</h5>
                                <div class="data-container">
                                    <div class="data-label">Charging Power per Phase (W)</div>
                                    <div class="data-value evcem-charging-power">-</div>
                                </div>
                                <h5>Scenario 3 - Charged Energy</h5>
                                <div class="data-container">
                                    <div class="data-label">Energy Charged (Wh)</div>
                                    <div class="data-value evcem-charged-energy">-</div>
                                </div>
                            </div>
                            <div style="height:1px;background:grey;margin:6px 0"></div>

                            <!-- OPEV-->
                            <div class="usecase-header">
                                <div class="usecase-label">OPEV</div>
                                <span class="support-badge unsupported opev-badge">not supported</span>
                            </div>
                            <div class="usecase-content disabled opev-content">
                                <h5>Scenario 1 - Load Control Limit</h5>
                                <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                                    <div class="data-container">
                                        <div class="data-label">Load Control Limit (A)</div>
                                        <div class="data-value opev-load-limit">-</div>
                                    </div>
                                </div>
                                <div style="display:flex; gap:8px; align-items:center; margin-top:8px;">
                                    <input class="write-opev-limit-value" type="number" placeholder="limit (A)" style="width:90px" value="16"/>
                                    <label style="display:flex;align-items:center;gap:6px;margin:0"><input class="write-opev-limit-active" type="checkbox" checked/> Active</label>
                                    <button class="send-write-opev-limit">Send Load Control Limit</button>
                                </div>
                                <h5>Scenario 2 - Current Limits</h5>
                                <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                                    <div class="data-container">
                                        <div class="data-label">Minimum (A)</div>
                                        <div class="data-value opev-current-limit-min">-</div>
                                    </div>
                                    <div class="data-container">
                                        <div class="data-label">Maximum (A)</div>
                                        <div class="data-value opev-current-limit-max">-</div>
                                    </div>
                                    <div class="data-container">
                                        <div class="data-label">Default (A)</div>
                                        <div class="data-value opev-current-limit-default">-</div>
                                    </div>
                                </div>
                            </div>
                            <div style="height:1px;background:grey;margin:6px 0"></div>

                            <!-- OSCEV-->
                            <div class="usecase-header">
                                <div class="usecase-label">OSCEV</div>
                                <span class="support-badge unsupported oscev-badge">not supported</span>
                            </div>
                            <div class="usecase-content disabled oscev-content">
                                <h5>Scenario 1 - Load Control Limit</h5>
                                <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                                    <div class="data-container">
                                        <div class="data-label">Load Control Limit (A)</div>
                                        <div class="data-value oscev-load-limit">-</div>
                                    </div>
                                </div>
                                <div style="display:flex; gap:8px; align-items:center; margin-top:8px;">
                                    <input class="write-oscev-limit-value" type="number" placeholder="limit (A)" style="width:90px" value="16"/>
                                    <label style="display:flex;align-items:center;gap:6px;margin:0"><input class="write-oscev-limit-active" type="checkbox" checked/> Active</label>
                                    <button class="send-write-oscev-limit">Send Load Control Limit</button>
                                </div>
                                <h5>Scenario 2 - Current Limits</h5>
                                <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                                    <div class="data-container">
                                        <div class="data-label">Minimum (A)</div>
                                        <div class="data-value oscev-current-limit-min">-</div>
                                    </div>
                                    <div class="data-container">
                                        <div class="data-label">Maximum (A)</div>
                                        <div class="data-value oscev-current-limit-max">-</div>
                                    </div>
                                    <div class="data-container">
                                        <div class="data-label">Default (A)</div>
                                        <div class="data-value oscev-current-limit-default">-</div>
                                    </div>
                                </div>
                            </div>
                            <div style="height:1px;background:grey;margin:6px 0"></div>

                            <!-- EVSOC-->
                            <div class="usecase-header">
                                <div class="usecase-label">EVSOC</div>
                                <span class="support-badge unsupported evsoc-badge">not supported</span>
                            </div>
                            <div class="usecase-content disabled evsoc-content">
                                <h5>Scenario 1 - State of Charge</h5>
                                <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                                    <div class="data-container">
                                        <div class="data-label">State of Charge (%)</div>
                                        <div class="data-value evsoc-state-of-charge">-</div>
                                    </div>
                                </div>
                            </div>
                            <div style="height:1px;background:grey;margin:6px 0"></div>

                            <!-- CEVC-->
                            <div class="usecase-header">
                                <div class="usecase-label">CEVC</div>
                                <span class="support-badge unsupported cevc-badge">not supported</span>
                            </div>
                            <div class="usecase-content disabled cevc-content">
                                <h5>Charge Strategy</h5>
                                <div class="data-container">
                                    <div class="data-label">Current Strategy</div>
                                    <div class="data-value cevc-charge-strategy">-</div>
                                </div>
                                <h5>Energy Demand</h5>
                                <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                                    <div class="data-container">
                                        <div class="data-label">Min Demand (Wh)</div>
                                        <div class="data-value cevc-min-demand">-</div>
                                    </div>
                                    <div class="data-container">
                                        <div class="data-label">Opt Demand (Wh)</div>
                                        <div class="data-value cevc-opt-demand">-</div>
                                    </div>
                                    <div class="data-container">
                                        <div class="data-label">Max Demand (Wh)</div>
                                        <div class="data-value cevc-max-demand">-</div>
                                    </div>
                                    <div class="data-container">
                                        <div class="data-label">Duration Until Start (s)</div>
                                        <div class="data-value cevc-duration-start">-</div>
                                    </div>
                                    <div class="data-container">
                                        <div class="data-label">Duration Until End (s)</div>
                                        <div class="data-value cevc-duration-end">-</div>
                                    </div>
                                </div>
                                <h5>Charge Plan</h5>
                                <div class="data-container">
                                    <div class="data-label">Charge Plan Slots</div>
                                    <div class="data-value cevc-charge-plan" style="white-space:pre-wrap;font-size:11px;">-</div>
                                </div>
                            </div>
                            <div style="height:1px;background:grey;margin:6px 0"></div>

                            <!-- MPC-->
                            <div class="usecase-header">
                                <div class="usecase-label">MPC</div>
                                <span class="support-badge unsupported mpc-badge">not supported</span>
                            </div>
                            <div class="usecase-content disabled mpc-content">
                                <h5>Power Measurements</h5>
                                <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                                    <div class="data-container">
                                        <div class="data-label">Total Power (W)</div>
                                        <div class="data-value mpc-power">-</div>
                                    </div>
                                    <div class="data-container">
                                        <div class="data-label">Power per Phase (W)</div>
                                        <div class="data-value mpc-power-per-phase">-</div>
                                    </div>
                                </div>
                                <h5>Current and Voltage</h5>
                                <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                                    <div class="data-container">
                                        <div class="data-label">Current per Phase (A)</div>
                                        <div class="data-value mpc-current-per-phase">-</div>
                                    </div>
                                    <div class="data-container">
                                        <div class="data-label">Voltage per Phase (V)</div>
                                        <div class="data-value mpc-voltage-per-phase">-</div>
                                    </div>
                                    <div class="data-container">
                                        <div class="data-label">Frequency (Hz)</div>
                                        <div class="data-value mpc-frequency">-</div>
                                    </div>
                                </div>
                                <h5>Energy</h5>
                                <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                                    <div class="data-container">
                                        <div class="data-label">Energy Consumed (Wh)</div>
                                        <div class="data-value mpc-energy-consumed">-</div>
                                    </div>
                                    <div class="data-container">
                                        <div class="data-label">Energy Produced (Wh)</div>
                                        <div class="data-value mpc-energy-produced">-</div>
                                    </div>
                                </div>
                            </div>

                            <!-- MGCP-->
                            <div class="usecase-header">
                                <div class="usecase-label">MGCP</div>
                                <span class="support-badge unsupported mgcp-badge">not supported</span>
                            </div>
                            <div class="usecase-content disabled mgcp-content">
                                <h5>Grid Connection Point Data</h5>
                                <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                                    <div class="data-container">
                                        <div class="data-label">Power (W)</div>
                                        <div class="data-value mgcp-power">-</div>
                                    </div>
                                    <div class="data-container">
                                        <div class="data-label">Power Limitation Factor (%)</div>
                                        <div class="data-value mgcp-power-limitation-factor">-</div>
                                    </div>
                                </div>
                                <h5>Current and Voltage</h5>
                                <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                                    <div class="data-container">
                                        <div class="data-label">Current per Phase (A)</div>
                                        <div class="data-value mgcp-current-per-phase">-</div>
                                    </div>
                                    <div class="data-container">
                                        <div class="data-label">Voltage per Phase (V)</div>
                                        <div class="data-value mgcp-voltage-per-phase">-</div>
                                    </div>
                                    <div class="data-container">
                                        <div class="data-label">Frequency (Hz)</div>
                                        <div class="data-value mgcp-frequency">-</div>
                                    </div>
                                </div>
                                <h5>Energy</h5>
                                <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                                    <div class="data-container">
                                        <div class="data-label">Energy Feed In (Wh)</div>
                                        <div class="data-value mgcp-energy-feed-in">-</div>
                                    </div>
                                    <div class="data-container">
                                        <div class="data-label">Energy Consumed (Wh)</div>
                                        <div class="data-value mgcp-energy-consumed">-</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Entities Panel -->
                    <section class="card" style="padding:12px">
                        <h3 style="margin:0 0 6px 0">Entities</h3>
                        <div class="entities-status" style="color:var(--muted); font-size:13px; margin-bottom:6px">Loading entities...</div>
                        <ul class="entities-list"></ul>
                    </section>
                </div>

                <!-- Right Column: SPINE Messages & Logs -->
                <div class="peer-content-right card" style="padding:12px">
                    <h3 style="margin:0 0 6px 0">SPINE Messages / Trace Log</h3>
                    <div class="sub-tabs">
                        <button class="active" onclick="openSubTab(this, 'spine')">Spine Messages</button>
                        <button onclick="openSubTab(this, 'log')">Trace Log</button>
                    </div>
                    <div class="subtab-content active" data-subtab="spine">
                        <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
                            <div class="parsed-traces-status" style="color:var(--muted); font-size:13px">Waiting for spine messages...</div>
                            <div style="display:flex; gap:8px; align-items:center;">
                                <label style="font-size:13px;color:var(--muted);"><input class="eebus-json-checkbox" type="checkbox" checked style="margin-right:6px;">EEBUS Json Format</label>
                                <button class="clear-parsed-btn secondary" type="button">Clear Parsed</button>
                            </div>
                        </div>
                        <ul class="parsed-traces-list"></ul>
                        <div class="trace-detail-panel" style="position:relative;margin-top:8px;display:flex;flex-direction:column;gap:8px;">
                            <div style="display:flex; align-items:center; gap:8px; justify-content:space-between;">
                                <div style="font-size:13px;color:var(--muted);">Click an entry to view the full JSON</div>
                                <button class="trace-detail-close" title="Close detail" type="button" style="display:none;background:#0b1220;border:1px solid rgba(255,255,255,0.2);color:#fff;cursor:pointer;padding:2px 8px;border-radius:6px">Close</button>
                            </div>
                            <div class="trace-detail">Click an entry to view the full JSON.</div>
                        </div>
                    </div>
                    <div class="subtab-content" data-subtab="log">
                        <div style="display:flex; align-items:center; justify-content:space-between;">
                            <div style="color:var(--muted);">Trace Log (raw)</div>
                            <button class="logs-to-bottom-btn" style="display:none; background:#2563eb; color:#fff; border:0; padding:6px 10px; border-radius:6px; cursor:pointer">Scroll to bottom</button>
                        </div>
                        <div class="peer-logs">Waiting for logs...</div>
                    </div>
                </div>
            </div>
        </div>
    </template>
</div>

<script>
// ========== STATE MANAGEMENT ==========
const peersState = {
    peers: [],
    activeTab: 'peers-list',
    peerTabs: new Set(),
    peerData: {},
    ws: null,
    config: null
};

function createPeerData(ski) {
    return {
        ski: ski,
        usecaseData: {},
        entities: [],
        traces: [],
        logs: [],
        usecaseSupport: {},
        connected: false,
        traceIdCounter: 1,
        lastShownTrace: null,
        expandedStates: {},
        logsAutoScroll: true
    };
}

// ========== CONFIGURATION ==========

async function loadConfig() {
    try {
        const res = await fetch('/api/config');
        if (!res.ok) throw new Error('Failed to fetch config');
        const config = await res.json();
        peersState.config = config;
        console.log('Config loaded:', config);
    } catch (err) {
        console.error('Error loading config:', err);
    }
}

function hideDisabledUsecases(container) {
    if (!peersState.config || !peersState.config.usecases) return;

    const isSeparator = (el) => {
        if (!el || !el.tagName || el.tagName.toLowerCase() !== 'div') return false;
        if (el.classList && el.classList.contains('usecase-separator')) return true;
        const style = (el.getAttribute('style') || '').replace(/\s+/g, '').toLowerCase();
        return style.includes('height:1px') && style.includes('background:grey');
    };

    const usecases = Object.keys(peersState.config.usecases || {});

    usecases.forEach(uc => {
        const cfg = peersState.config.usecases[uc];
        if (!cfg || cfg.enabled === true) return;

        // content blocks use the pattern `.{uc}-content` (e.g. .lpc-content)
        const contentEls = Array.from(container.querySelectorAll('.' + uc + '-content'));
        if (contentEls.length === 0) {
            const alt = container.querySelector('.' + uc.toLowerCase() + '-content');
            if (alt) contentEls.push(alt);
        }

        contentEls.forEach(contentEl => {
            contentEl.style.display = 'none';

            const prev = contentEl.previousElementSibling;
            if (prev && prev.classList && prev.classList.contains('usecase-header')) {
                prev.style.display = 'none';
            } else {
                const badge = container.querySelector('.' + uc + '-badge');
                if (badge) {
                    const header = badge.closest('.usecase-header');
                    if (header) header.style.display = 'none';
                }
            }

            const next = contentEl.nextElementSibling;
            if (isSeparator(next)) {
                next.style.display = 'none';
            }
        });
    });

    // Normalize separators: only show between visible usecase blocks
    const usecaseContainer = container.querySelector('.peer-content-left section.card > div[style*="flex-direction:column"]');
    if (!usecaseContainer) return;

    const allSeparators = Array.from(usecaseContainer.children).filter(isSeparator);
    allSeparators.forEach(sep => {
        sep.style.display = 'none';
    });

    const allContents = Array.from(usecaseContainer.querySelectorAll('.usecase-content'));
    const visibleContents = allContents.filter(el => el.style.display !== 'none');

    visibleContents.forEach((contentEl, idx) => {
        if (idx === visibleContents.length - 1) return;
        const next = contentEl.nextElementSibling;
        if (isSeparator(next)) {
            next.style.display = '';
        }
    });
}

// ========== PEER TABS MANAGEMENT ==========

function switchPeerTab(tabId) {
    document.querySelectorAll('.peer-tab-content').forEach(el => {
        el.classList.remove('active');
    });
    document.querySelectorAll('.peer-tab').forEach(el => {
        el.classList.remove('active');
    });
    
    const content = document.getElementById('tab-' + tabId);
    if (content) {
        content.classList.add('active');
    }
    
    const tab = document.querySelector(`.peer-tab[data-tab="${tabId}"]`);
    if (tab) {
        tab.classList.add('active');
    }
    
    peersState.activeTab = tabId;
    
    if (tabId !== 'peers-list') {
        const ski = tabId.replace('peer-', '');
        refreshPeerData(ski);
    }
}

function openPeerTab(ski) {
    const tabId = 'peer-' + ski;
    
    if (peersState.peerTabs.has(ski)) {
        switchPeerTab(tabId);
        return;
    }
    
    if (!peersState.peerData[ski]) {
        peersState.peerData[ski] = createPeerData(ski);
    }
    
    const peer = peersState.peers.find(p => p.ski === ski);
    // Show device name if available, otherwise show full SKI (shortened only if too long for tab)
    let label;
    if (peer && peer.deviceName) {
        label = peer.deviceName;
    } else if (peer && peer.brand && peer.model) {
        label = `${peer.brand} ${peer.model}`;
    } else {
        label = ski.length > 20 ? ski.substring(0, 20) + '...' : ski;
    }
    
    const tabTemplate = document.getElementById('peerTabTemplate');
    const tabBtn = tabTemplate.content.cloneNode(true).querySelector('.peer-tab');
    tabBtn.dataset.tab = tabId;
    tabBtn.querySelector('.tab-label').textContent = label;
    tabBtn.querySelector('.status-dot').classList.add(peer && peer.connected ? 'connected' : 'disconnected');
    
    tabBtn.querySelector('.close-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        closePeerTab(ski);
    });
    
    tabBtn.addEventListener('click', () => switchPeerTab(tabId));
    
    document.getElementById('peerTabsBar').appendChild(tabBtn);
    
    const contentTemplate = document.getElementById('peerContentTemplate');
    const content = contentTemplate.content.cloneNode(true).querySelector('.peer-tab-content');
    content.id = 'tab-' + tabId;
    content.dataset.ski = ski;
    
    content.querySelector('.peer-ski-display').textContent = 'SKI: ' + ski;
    
    // Hide disabled usecases based on config
    hideDisabledUsecases(content);
    
    document.querySelector('.peer-tabs-container').appendChild(content);
    
    initPeerTabHandlers(content, ski);
    
    peersState.peerTabs.add(ski);
    switchPeerTab(tabId);
    refreshPeerData(ski);
}

function closePeerTab(ski) {
    const tabId = 'peer-' + ski;
    
    const tabBtn = document.querySelector(`.peer-tab[data-tab="${tabId}"]`);
    if (tabBtn) tabBtn.remove();
    
    const content = document.getElementById('tab-' + tabId);
    if (content) content.remove();
    
    peersState.peerTabs.delete(ski);
    
    if (peersState.activeTab === tabId) {
        switchPeerTab('peers-list');
    }
}

function updatePeerTabStatus(ski, connected) {
    const tabId = 'peer-' + ski;
    const tabBtn = document.querySelector(`.peer-tab[data-tab="${tabId}"]`);
    if (tabBtn) {
        const dot = tabBtn.querySelector('.status-dot');
        dot.classList.remove('connected', 'disconnected');
        dot.classList.add(connected ? 'connected' : 'disconnected');
    }
    
    if (peersState.peerData[ski]) {
        peersState.peerData[ski].connected = connected;
    }
}

// ========== PEERS LIST ==========

async function connectToPeer(ski) {
    try {
        const res = await fetch('/api/connect', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ski: ski })
        });
        if (!res.ok) throw new Error('Failed to connect');
        const result = await res.json();
        console.log('Connecting to peer:', result);
        // Open the peer tab automatically when connecting
        openPeerTab(ski);
    } catch (err) {
        console.error('Error connecting to peer:', err);
        alert('Failed to connect: ' + err.message);
    }
}

async function fetchPeers() {
    try {
        const res = await fetch('/api/peers');
        if (!res.ok) throw new Error('Failed to fetch peers');
        const peers = await res.json();
        updatePeersList(peers);
    } catch (err) {
        console.error('Error fetching peers:', err);
        document.getElementById('peersTableBody').innerHTML = `
            <tr><td colspan="4" style="text-align:center;padding:40px;color:var(--danger)">
                Error loading peers: ${err.message}
            </td></tr>
        `;
    }
}

function updatePeersList(peers) {
    peersState.peers = peers;
    document.getElementById('peersCount').textContent = peers.length + ' peer' + (peers.length !== 1 ? 's' : '') + ' discovered';
    
    const tbody = document.getElementById('peersTableBody');
    
    if (peers.length === 0) {
        tbody.innerHTML = `
            <tr><td colspan="4" style="text-align:center;padding:40px;color:var(--muted)">
                No peers discovered yet. Waiting for EEBUS devices...
            </td></tr>
        `;
        return;
    }
    
    tbody.innerHTML = peers.map(peer => {
        const statusClass = peer.connected ? 'status-connected' : 'status-disconnected';
        const statusText = peer.connected ? 'Connected' : 'Disconnected';
        
        // Build device info string
        let deviceInfo = 'Unknown Device';
        if (peer.brand && peer.model) {
            deviceInfo = `${peer.brand} ${peer.model}`;
        } else if (peer.deviceName) {
            deviceInfo = peer.deviceName;
        } else if (peer.brand) {
            deviceInfo = peer.brand;
        } else if (peer.model) {
            deviceInfo = peer.model;
        }
        
        // Additional details
        let details = [];
        if (peer.deviceType && peer.deviceType !== 'Unknown') details.push(peer.deviceType);
        if (peer.serial) details.push(`SN: ${peer.serial}`);
        if (peer.identifier && peer.identifier !== peer.ski) details.push(`ID: ${peer.identifier}`);
        
        const detailsHtml = details.length > 0 ? `<br><small style="color:var(--muted)">${details.join(' | ')}</small>` : '';
        
        // Show Connect button for disconnected peers, Open button for connected
        const actionButton = peer.connected 
            ? `<button onclick="openPeerTab('${peer.ski}')">Open</button>`
            : `<button onclick="connectToPeer('${peer.ski}')" style="background:var(--success);color:white">Connect</button>`;
        
        return `
            <tr>
                <td class="${statusClass}">${statusText}</td>
                <td class="ski-cell" style="font-family:monospace;font-size:12px">${peer.ski}</td>
                <td>${deviceInfo}${detailsHtml}</td>
                <td>${actionButton}</td>
            </tr>
        `;
    }).join('');
    
    peers.forEach(peer => {
        updatePeerTabStatus(peer.ski, peer.connected);
    });
}

// ========== PEER TAB INITIALIZATION ==========

function initPeerTabHandlers(container, ski) {
    const apiWriteForPeer = (payload) => apiWrite({...payload, ski});
    
    container.querySelector('.send-write-limit').addEventListener('click', () => {
        const val = parseFloat(container.querySelector('.write-limit-value').value) || 0;
        const dur = parseInt(container.querySelector('.write-limit-duration').value, 10) || 0;
        const active = container.querySelector('.write-limit-active').checked;
        apiWriteForPeer({cmd: 'writeLPCConsumptionLimit', durationSeconds: dur, value: val, isActive: active});
    });
    
    container.querySelector('.send-write-failsafe-power').addEventListener('click', () => {
        const p = parseFloat(container.querySelector('.write-failsafe-power').value) || 0;
        apiWriteForPeer({cmd: 'writeLPCFailsafeValue', failsafePower: p});
    });
    
    container.querySelector('.send-write-failsafe-duration').addEventListener('click', () => {
        const m = parseInt(container.querySelector('.write-failsafe-duration').value, 10) || 0;
        apiWriteForPeer({cmd: 'writeLPCFailsafeDuration', durationMinutes: m});
    });
    
    container.querySelector('.send-write-lpp-limit').addEventListener('click', () => {
        const val = parseFloat(container.querySelector('.write-lpp-limit-value').value) || 0;
        const dur = parseInt(container.querySelector('.write-lpp-limit-duration').value, 10) || 0;
        const active = container.querySelector('.write-lpp-limit-active').checked;
        apiWriteForPeer({cmd: 'writeLPPProductionLimit', durationSeconds: dur, value: val, isActive: active});
    });
    
    container.querySelector('.send-write-lpp-failsafe-power').addEventListener('click', () => {
        const p = parseFloat(container.querySelector('.write-lpp-failsafe-power').value) || 0;
        apiWriteForPeer({cmd: 'writeLPPFailsafeValue', failsafePower: p});
    });
    
    container.querySelector('.send-write-lpp-failsafe-duration').addEventListener('click', () => {
        const m = parseInt(container.querySelector('.write-lpp-failsafe-duration').value, 10) || 0;
        apiWriteForPeer({cmd: 'writeLPPFailsafeDuration', durationMinutes: m});
    });
    
    container.querySelector('.send-write-oscev-limit').addEventListener('click', () => {
        const val = parseFloat(container.querySelector('.write-oscev-limit-value').value) || 0;
        const active = container.querySelector('.write-oscev-limit-active').checked;
        apiWriteForPeer({cmd: 'writeOSCEVLoadControlLimits', value: val, isActive: active});
    });
    
    container.querySelector('.send-write-opev-limit').addEventListener('click', () => {
        const val = parseFloat(container.querySelector('.write-opev-limit-value').value) || 0;
        const active = container.querySelector('.write-opev-limit-active').checked;
        apiWriteForPeer({cmd: 'writeOPEVLoadControlLimits', value: val, isActive: active});
    });
    
    container.querySelector('.clear-parsed-btn').addEventListener('click', () => {
        clearPeerTraces(ski);
    });
    
    container.querySelector('.trace-detail-close').addEventListener('click', function() {
        container.querySelector('.trace-detail').style.display = 'none';
        this.style.display = 'none';
        peersState.peerData[ski].lastShownTrace = null;
    });

    const formatToggle = container.querySelector('.eebus-json-checkbox');
    if (formatToggle) {
        formatToggle.addEventListener('change', () => {
            const peerData = peersState.peerData[ski];
            if (peerData && peerData.lastShownTrace) {
                updateTraceDetailContent(container, peerData.lastShownTrace);
            }
        });
    }
    
    const logsEl = container.querySelector('.peer-logs');
    const logsBtn = container.querySelector('.logs-to-bottom-btn');
    
    logsBtn.addEventListener('click', () => {
        peersState.peerData[ski].logsAutoScroll = true;
        logsEl.scrollTop = logsEl.scrollHeight;
        logsBtn.style.display = 'none';
    });
    
    logsEl.addEventListener('scroll', () => {
        const atBottom = (logsEl.scrollHeight - logsEl.scrollTop - logsEl.clientHeight) <= 8;
        peersState.peerData[ski].logsAutoScroll = atBottom;
        logsBtn.style.display = atBottom ? 'none' : 'inline-block';
    });
}

function openSubTab(btn, tabName) {
    const container = btn.closest('.peer-content-right') || document.querySelector('.peer-tab-content.active');
    if (!container) return;
    
    container.querySelectorAll('.subtab-content').forEach(el => {
        el.classList.remove('active');
    });
    
    container.querySelectorAll('.sub-tabs button').forEach(el => {
        el.classList.remove('active');
    });
    
    const content = container.querySelector(`.subtab-content[data-subtab="${tabName}"]`);
    if (content) {
        content.classList.add('active');
    }
    btn.classList.add('active');
}

// ========== PEER DATA REFRESH ==========

async function refreshPeerData(ski) {
    try {
        const res = await fetch(`/api/usecasedata?ski=${encodeURIComponent(ski)}`);
        if (res.ok) {
            const data = await res.json();
            updatePeerUsecaseData(ski, data);
        }
    } catch (err) {
        console.error('Error fetching usecase data for peer', ski, err);
    }
    
    try {
        const res = await fetch(`/api/entities?ski=${encodeURIComponent(ski)}`);
        if (res.ok) {
            const data = await res.json();
            updatePeerEntities(ski, data.entities || data);
        }
    } catch (err) {
        console.error('Error fetching entities for peer', ski, err);
    }
}

// ========== WEBSOCKET HANDLING ==========

function connectWebSocket() {
    const protocol = (location.protocol === 'https:') ? 'wss:' : 'ws:';
    const wsUrl = protocol + '//' + location.host + '/ws/logs';
    
    const ws = new WebSocket(wsUrl);
    
    ws.addEventListener('open', () => {
        console.log('WebSocket connected');
    });
    
    ws.addEventListener('message', handleWebSocketMessage);
    
    ws.addEventListener('close', () => {
        console.log('WebSocket closed, reconnecting...');
        setTimeout(connectWebSocket, 1000);
    });
    
    ws.addEventListener('error', (err) => {
        console.error('WebSocket error:', err);
    });
    
    peersState.ws = ws;
}

function handleWebSocketMessage(ev) {
    const line = (typeof ev.data === 'string') ? ev.data : JSON.stringify(ev.data);
    
    let parsed = null;
    try {
        parsed = JSON.parse(line);
    } catch (e) {
        parsed = null;
    }
    
    if (parsed && parsed.type === 'peers') {
        updatePeersList(parsed.peers || []);
        return;
    }
    
    if (parsed && parsed.type === 'usecase') {
        const ski = parsed.ski;
        if (ski && peersState.peerData[ski]) {
            peersState.peerData[ski].usecaseSupport[parsed.name] = parsed.supported;
            updatePeerUsecaseDisplay(ski, parsed.name, parsed.supported);
        }
        return;
    }
    
    if (parsed && parsed.type === 'entities') {
        const ski = parsed.ski;
        if (ski) {
            updatePeerEntities(ski, parsed.entities || []);
        }
        return;
    }
    
    const ski = extractSKIFromMessage(line);

    // Match TRACE/Trace followed by SKI (40 hex chars) followed by Recv/Send
    const isTrace = /TRACE\s+[a-fA-F0-9]{40}\s+(Recv|Send)/i.test(line) || /Trace\s+[a-fA-F0-9]{40}\s+(Recv|Send)/i.test(line);
    if (isTrace) {
        handleTraceMessage(ski, line, parsed);
        return;
    }
    
    if (ski) {
        addPeerLog(ski, line);
    } else {
        Object.keys(peersState.peerData).forEach(peerSki => {
            addPeerLog(peerSki, line);
        });
    }
}

function extractSKIFromMessage(line) {
    // SKI is exactly 40 hex characters (SHA-1 hash)
    const skiMatch = line.match(/\b([a-fA-F0-9]{40})\b/);
    if (skiMatch) {
        return skiMatch[1].toLowerCase();
    }
    return null;
}

function handleTraceMessage(ski, line, parsed) {
    const ts = extractTimestamp(line);
    const direction = extractDirection(line);
    const js = extractJsonString(line);
    
    if (js) {
        try {
            const obj = JSON.parse(js);
            const cmdClassifier = findValueByKey(obj, 'cmdClassifier') || '';
            const cmdType = findCmdType(obj) || '';
            
            const traceEntry = {
                id: 0,
                ts: ts,
                direction: direction,
                cmdClassifier: cmdClassifier,
                cmdType: cmdType,
                rawJson: obj,
                rawLine: line
            };
            
            if (ski) {
                addPeerTrace(ski, traceEntry);
            } else {
                Object.keys(peersState.peerData).forEach(peerSki => {
                    addPeerTrace(peerSki, Object.assign({}, traceEntry));
                });
            }
            return;
        } catch (e) {
        }
    }
    
    if (ski) {
        addPeerLog(ski, line);
    }
}

// ========== PEER DATA UPDATE FUNCTIONS ==========

function updatePeerUsecaseData(ski, data) {
    if (!peersState.peerData[ski]) {
        peersState.peerData[ski] = createPeerData(ski);
    }
    peersState.peerData[ski].usecaseData = data;
    
    const content = document.querySelector(`.peer-tab-content[data-ski="${ski}"]`);
    if (!content) return;
    
    const fallback = v => (v !== undefined ? v : '-');
    const setText = (selector, v) => {
        const el = content.querySelector(selector);
        if (el) el.textContent = String(fallback(v));
    };
    
    // LPC
    if (data.lpcLimitValue !== undefined) {
        setText('.lpc-limit-value', data.lpcLimitValue);
        setText('.lpc-limit-dur', data.lpcLimitDurSeconds);
        setText('.lpc-limit-active', data.lpcLimitActive);
        setText('.lpc-failsafe-power', data.lpcFailsafePower);
        setText('.lpc-failsafe-duration', data.lpcFailsafeDurMinutes);
        setText('.lpc-max-nominal-power', data.lpcConsumptionLimitNominalMax);
        setText('.lpc-heartbeat', data.lpcHeartbeatOk);
        setText('.lpc-heartbeat-timestamp', data.lpcHeartbeatTimestamp);
    }
    
    // LPP
    if (data.lppLimitValue !== undefined) {
        setText('.lpp-limit-value', data.lppLimitValue);
        setText('.lpp-limit-dur', data.lppLimitDurationSeconds);
        setText('.lpp-limit-active', data.lppLimitActive ? 'yes' : 'no');
        setText('.lpp-failsafe-value', data.lppFailsafeValue);
        setText('.lpp-failsafe-dur', data.lppFailsafeDurMinutes);
        setText('.lpp-heartbeat', data.lppHeartbeatOk);
        setText('.lpp-heartbeat-timestamp', data.lppHeartbeatTimestamp);
    }
    
    // EVSECC
    if (data.evseccManufacturerData) {
        updateManufacturerDisplay(content.querySelector('.evsecc-manufacturer'), data.evseccManufacturerData);
        setText('.evsecc-operating-state', data.evseccOperatingState);
        setText('.evsecc-error-message', data.evseccOperatingStateDescription);
    }
    
    // EVCC
    if (data.evccManufacturerData !== undefined) {
        updateManufacturerDisplay(content.querySelector('.evcc-manufacturer'), data.evccManufacturerData);
        setText('.evcc-ev-connected', data.evccEvConnected);
        setText('.evcc-comm-standard', data.evccCommunicationStandard);
        setText('.evcc-asymmetric-charging', data.evccAsymmetricChargingSupport);
        setText('.evcc-charging-limits-min', data.evccLimitMinimum);
        setText('.evcc-charging-limits-max', data.evccLimitMaximum);
        setText('.evcc-charging-limits-standby', data.evccLimitStandby);
        setText('.evcc-sleep-mode', data.evccSleepMode);
        if (data.evccIdentifications && data.evccIdentifications.length > 0) {
            setText('.evcc-identification-type', data.evccIdentifications[0].ValueType);
            setText('.evcc-identification-value', data.evccIdentifications[0].Value);
        }
    }
    
    // EVCEM
    if (data.evcemCurrentPerPhase !== undefined) {
        setText('.evcem-charging-current', formatPhaseArray(data.evcemCurrentPerPhase, 'A'));
        setText('.evcem-charging-power', formatPhaseArray(data.evcemPowerPerPhase, 'W'));
        setText('.evcem-charged-energy', data.evcemEnergyCharged);
    }
    
    // OPEV
    if (data.opevLoadControlLimit !== undefined) {
        setText('.opev-load-limit', formatLoadLimits(data.opevLoadControlLimit));
        setText('.opev-current-limit-min', formatPhaseArray(data.opevCurrentLimitMin, 'A'));
        setText('.opev-current-limit-max', formatPhaseArray(data.opevCurrentLimitMax, 'A'));
        setText('.opev-current-limit-default', formatPhaseArray(data.opevCurrentLimitDefault, 'A'));
    }
    
    // OSCEV
    if (data.oscevLoadControlLimit !== undefined) {
        setText('.oscev-load-limit', formatLoadLimits(data.oscevLoadControlLimit));
        setText('.oscev-current-limit-min', formatPhaseArray(data.oscevCurrentLimitMin, 'A'));
        setText('.oscev-current-limit-max', formatPhaseArray(data.oscevCurrentLimitMax, 'A'));
        setText('.oscev-current-limit-default', formatPhaseArray(data.oscevCurrentLimitDefault, 'A'));
    }
    
    // EVSOC
    if (data.evsocStateOfCharge !== undefined) {
        setText('.evsoc-state-of-charge', data.evsocStateOfCharge.toFixed(1));
    }
    
    // CEVC
    if (data.cevcChargeStrategy !== undefined) {
        setText('.cevc-charge-strategy', data.cevcChargeStrategy);
        if (data.cevcEnergyDemand) {
            setText('.cevc-min-demand', data.cevcEnergyDemand.MinDemand);
            setText('.cevc-opt-demand', data.cevcEnergyDemand.OptDemand);
            setText('.cevc-max-demand', data.cevcEnergyDemand.MaxDemand);
            setText('.cevc-duration-start', data.cevcEnergyDemand.DurationUntilStart);
            setText('.cevc-duration-end', data.cevcEnergyDemand.DurationUntilEnd);
        }
        if (data.cevcChargePlan && data.cevcChargePlan.Slots) {
            const planText = data.cevcChargePlan.Slots.map((slot, i) => {
                return 'Slot ' + (i + 1) + ': ' + slot.Start + 's - ' + slot.End + 's | Power: ' + slot.MinPower + 'W - ' + slot.MaxPower + 'W | Energy: ' + slot.MinEnergy + 'Wh - ' + slot.MaxEnergy + 'Wh';
            }).join('\n');
            setText('.cevc-charge-plan', planText || '-');
        }
    }
    
    // MPC
    if (data.mpcPower !== undefined) {
        setText('.mpc-power', data.mpcPower);
        setText('.mpc-power-per-phase', formatPhaseArray(data.mpcPowerPerPhase, 'W'));
        setText('.mpc-current-per-phase', formatPhaseArray(data.mpcCurrentPerPhase, 'A'));
        setText('.mpc-voltage-per-phase', formatPhaseArray(data.mpcVoltagePerPhase, 'V'));
        setText('.mpc-frequency', data.mpcFrequency);
        setText('.mpc-energy-consumed', data.mpcEnergyConsumed);
        setText('.mpc-energy-produced', data.mpcEnergyProduced);
    }
    
    // MGCP
    if (data.mgcPower !== undefined) {
        setText('.mgcp-power', data.mgcPower);
        setText('.mgcp-power-limitation-factor', data.mgcPowerLimitationFactor);
        setText('.mgcp-current-per-phase', formatPhaseArray(data.mgcCurrentPerPhase, 'A'));
        setText('.mgcp-voltage-per-phase', formatPhaseArray(data.mgcVoltagePerPhase, 'V'));
        setText('.mgcp-frequency', data.mgcFrequency);
        setText('.mgcp-energy-feed-in', data.mgcEnergyFeedIn);
        setText('.mgcp-energy-consumed', data.mgcEnergyConsumed);
    }
    
    if (data.usecaseSupport) {
        Object.entries(data.usecaseSupport).forEach(([name, supported]) => {
            updatePeerUsecaseDisplay(ski, name, supported);
        });
    }
}

function updatePeerUsecaseDisplay(ski, name, supported) {
    const content = document.querySelector(`.peer-tab-content[data-ski="${ski}"]`);
    if (!content) return;
    
    const n = name.toLowerCase();
    const badge = content.querySelector('.' + n + '-badge');
    const contentDiv = content.querySelector('.' + n + '-content');
    
    if (badge) {
        badge.textContent = supported ? 'supported' : 'not supported';
        badge.classList.remove('supported', 'unsupported');
        badge.classList.add(supported ? 'supported' : 'unsupported');
    }
    if (contentDiv) {
        if (supported) {
            contentDiv.classList.remove('disabled');
        } else {
            contentDiv.classList.add('disabled');
        }
    }
}

function updatePeerEntities(ski, entities) {
    if (!peersState.peerData[ski]) {
        peersState.peerData[ski] = createPeerData(ski);
    }
    peersState.peerData[ski].entities = entities;
    
    const content = document.querySelector(`.peer-tab-content[data-ski="${ski}"]`);
    if (!content) return;
    
    const container = content.querySelector('.entities-list');
    const statusEl = content.querySelector('.entities-status');
    const expandedStates = peersState.peerData[ski].expandedStates;
    
    if (!entities || entities.length === 0) {
        statusEl.textContent = 'No entities available';
        container.innerHTML = '';
        return;
    }
    
    statusEl.textContent = entities.length + ' entity(s)';
    
    const prevScroll = container.scrollTop;
    
    container.innerHTML = '';
    entities.forEach((ent, entIndex) => {
        const li = document.createElement('li');
        li.style.cssText = 'padding:8px;border-bottom:1px solid #f1f5f9';
        
        const entKey = String(ent.address || '') || ('ent-' + entIndex);
        const toggle = document.createElement('span');
        toggle.className = 'tree-toggle';
        toggle.textContent = '+';
        toggle.style.cssText = 'display:inline-block;width:18px;text-align:center;color:var(--muted)';
        
        const title = document.createElement('span');
        title.className = 'entity-addr';
        title.style.fontWeight = '600';
        title.textContent = (ent.address || '') + ' ';
        
        const etype = document.createElement('span');
        etype.style.cssText = 'color:var(--muted);font-size:13px';
        etype.textContent = (ent.entityType ? ('[' + ent.entityType + ']') : '');
        
        li.appendChild(toggle);
        li.appendChild(title);
        li.appendChild(etype);
        
        const sub = document.createElement('div');
        sub.className = 'sub';
        sub.style.cssText = 'margin-left:12px;font-size:13px;color:#333;display:none';
        
        if (Array.isArray(ent.features)) {
            ent.features.forEach((f, featIndex) => {
                const fdiv = document.createElement('div');
                const fname = document.createElement('div');
                fname.style.fontWeight = '600';
                fname.textContent = (f.name || '');
                const froles = document.createElement('div');
                froles.style.color = 'var(--muted)';
                froles.textContent = 'Roles: ' + (f.roles || '');
                fdiv.appendChild(fname);
                fdiv.appendChild(froles);
                
                if (Array.isArray(f.operations) && f.operations.length > 0) {
                    const opl = document.createElement('ul');
                    opl.style.cssText = 'margin:6px 0 8px 12px;padding:0 0 0 14px;list-style:disc';
                    f.operations.forEach(op => {
                        const oli = document.createElement('li');
                        const opKey = String(op.op || '');
                        const opName = String(op.name || '');
                        oli.textContent = opKey && opName ? opKey + ' - ' + opName : (opName || opKey);
                        opl.appendChild(oli);
                    });
                    fdiv.appendChild(opl);
                }
                
                const featKey = entKey + '::' + featIndex;
                if (expandedStates[featKey]) {
                    fdiv.style.display = 'block';
                }
                sub.appendChild(fdiv);
            });
        }
        
        li.appendChild(sub);
        
        const anyExpanded = Object.keys(expandedStates).some(k => k.startsWith(entKey + '::'));
        if (anyExpanded) {
            sub.style.display = 'block';
            toggle.textContent = '-';
        }
        
        toggle.addEventListener('click', (e) => {
            e.stopPropagation();
            const isOpen = sub.style.display !== 'none';
            if (isOpen) {
                sub.style.display = 'none';
                toggle.textContent = '+';
                Object.keys(expandedStates).forEach(k => {
                    if (k.startsWith(entKey + '::')) delete expandedStates[k];
                });
            } else {
                sub.style.display = 'block';
                toggle.textContent = '-';
                const featCount = (Array.isArray(ent.features) ? ent.features.length : 0);
                for (let i = 0; i < featCount; i++) {
                    expandedStates[entKey + '::' + i] = true;
                }
            }
        });
        
        title.addEventListener('click', () => toggle.click());
        
        container.appendChild(li);
    });
    
    container.scrollTop = prevScroll;
}

function addPeerTrace(ski, traceEntry) {
    if (!peersState.peerData[ski]) {
        peersState.peerData[ski] = createPeerData(ski);
    }
    
    const peerData = peersState.peerData[ski];
    traceEntry.id = peerData.traceIdCounter++;
    peerData.traces.unshift(traceEntry);
    if (peerData.traces.length > 500) peerData.traces.pop();
    
    const content = document.querySelector(`.peer-tab-content[data-ski="${ski}"]`);
    if (!content) return;
    
    const list = content.querySelector('.parsed-traces-list');
    const statusEl = content.querySelector('.parsed-traces-status');
    
    statusEl.textContent = '';
    
    const li = document.createElement('li');
    li.style.cssText = 'padding:6px 8px;margin:4px 0;border-radius:6px;display:flex;gap:8px;align-items:center;cursor:pointer;background:#fff;box-shadow:0 0 0 1px rgba(0,0,0,0.02) inset;font-size:13px;line-height:18px';
    li.dataset.id = traceEntry.id;
    
    const ts = document.createElement('div');
    ts.className = 'trace-ts';
    ts.textContent = traceEntry.ts || '';
    
    const dir = document.createElement('div');
    dir.className = traceEntry.direction === 'recv' ? 'dir-recv' : 'dir-send';
    dir.textContent = (traceEntry.direction || '').toUpperCase();
    
    const meta = document.createElement('div');
    meta.style.cssText = 'display:flex;gap:10px;align-items:center;font-size:13px;color:#111';
    meta.innerHTML = '<span style="color:var(--muted)">cmdClassifier:</span> ' + (traceEntry.cmdClassifier || '-') + ' &nbsp; <span style="color:var(--muted)">type:</span> ' + (traceEntry.cmdType || '-');
    
    li.appendChild(ts);
    li.appendChild(dir);
    li.appendChild(meta);
    
    li.addEventListener('click', () => showPeerTraceDetail(ski, traceEntry));
    
    list.insertBefore(li, list.firstChild);
    
    while (list.children.length > 100) {
        list.removeChild(list.lastChild);
    }
}

function showPeerTraceDetail(ski, traceEntry) {
    const content = document.querySelector(`.peer-tab-content[data-ski="${ski}"]`);
    if (!content) return;
    
    const peerData = peersState.peerData[ski];
    
    if (peerData.lastShownTrace) {
        const prevEl = content.querySelector('li[data-id="' + peerData.lastShownTrace.id + '"]');
        if (prevEl) prevEl.classList.remove('selected');
    }
    
    peerData.lastShownTrace = traceEntry;
    
    const li = content.querySelector('li[data-id="' + traceEntry.id + '"]');
    if (li) {
        li.classList.add('selected');
        li.scrollIntoView({behavior: 'smooth', block: 'nearest'});
    }
    
    updateTraceDetailContent(content, traceEntry);
}

function updateTraceDetailContent(content, traceEntry) {
    if (!content || !traceEntry) return;

    const detail = content.querySelector('.trace-detail');
    const checkbox = content.querySelector('.eebus-json-checkbox');
    const isRaw = checkbox && checkbox.checked;

    let text = '';
    if (traceEntry.rawJson) {
        text = isRaw ? JSON.stringify(traceEntry.rawJson, null, 2) : eebusJsonToJson(JSON.stringify(traceEntry.rawJson));
    } else {
        text = traceEntry.rawLine || '';
    }

    detail.textContent = text;
    detail.style.display = 'block';

    const closeBtn = content.querySelector('.trace-detail-close');
    if (closeBtn) closeBtn.style.display = 'inline-block';
}

function addPeerLog(ski, line) {
    if (!peersState.peerData[ski]) {
        peersState.peerData[ski] = createPeerData(ski);
    }
    
    const peerData = peersState.peerData[ski];
    peerData.logs.push(line);
    if (peerData.logs.length > 1000) peerData.logs.shift();
    
    const content = document.querySelector(`.peer-tab-content[data-ski="${ski}"]`);
    if (!content) return;
    
    const logsEl = content.querySelector('.peer-logs');
    const logsBtn = content.querySelector('.logs-to-bottom-btn');
    
    if (logsEl.textContent === 'Waiting for logs...') {
        logsEl.textContent = line;
    } else {
        logsEl.textContent += '\n' + line;
    }
    
    if (peerData.logsAutoScroll) {
        logsEl.scrollTop = logsEl.scrollHeight;
    } else {
        logsBtn.style.display = 'inline-block';
    }
}

function clearPeerTraces(ski) {
    if (peersState.peerData[ski]) {
        peersState.peerData[ski].traces = [];
        peersState.peerData[ski].lastShownTrace = null;
    }
    
    const content = document.querySelector(`.peer-tab-content[data-ski="${ski}"]`);
    if (!content) return;
    
    content.querySelector('.parsed-traces-list').innerHTML = '';
    content.querySelector('.parsed-traces-status').textContent = 'Waiting for spine messages...';
    
    const detail = content.querySelector('.trace-detail');
    detail.style.display = 'none';
    detail.textContent = 'Click an entry to view the full JSON.';
    
    const closeBtn = content.querySelector('.trace-detail-close');
    if (closeBtn) closeBtn.style.display = 'none';
}

// ========== HELPER FUNCTIONS ==========

function formatLoadLimits(limits) {
    if (!limits || !Array.isArray(limits) || limits.length === 0) return '-';
    return limits.map(l => {
        const phase = l.Phase !== undefined ? 'P' + l.Phase : '';
        const val = l.Value !== undefined ? l.Value : '-';
        const active = l.IsActive ? ' (active)' : ' (inactive)';
        return phase + ': ' + val + 'A' + active;
    }).join(', ');
}

function formatPhaseArray(arr, unit) {
    if (!arr || !Array.isArray(arr) || arr.length === 0) return '-';
    return arr.map((v, i) => 'P' + (i + 1) + ': ' + v + unit).join(', ');
}

function updateManufacturerDisplay(el, data) {
    if (!el || !data) return;
    el.innerHTML = '<div style="display:flex;flex-wrap:wrap;gap:12px">' +
        '<div><div style="font-size:12px;color:var(--muted)">Device</div><div style="font-weight:600">' + (data.DeviceName || '-') + '</div></div>' +
        '<div><div style="font-size:12px;color:var(--muted)">Code</div><div style="font-weight:600">' + (data.DeviceCode || '-') + '</div></div>' +
        '<div><div style="font-size:12px;color:var(--muted)">Serial</div><div style="font-weight:600">' + (data.SerialNumber || '-') + '</div></div>' +
        '<div><div style="font-size:12px;color:var(--muted)">SW</div><div style="font-weight:600">' + (data.SoftwareRevision || '-') + '</div></div>' +
        '<div><div style="font-size:12px;color:var(--muted)">HW</div><div style="font-weight:600">' + (data.HardwareRevision || '-') + '</div></div>' +
        '<div><div style="font-size:12px;color:var(--muted)">Vendor</div><div style="font-weight:600">' + (data.VendorName || '-') + '</div></div>' +
        '</div>';
}

// ========== TRACE PARSING HELPERS ==========

function extractTimestamp(line) {
    const ts = (typeof line === 'string') ? line.slice(0, 19) : '';
    if (/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/.test(ts)) return ts;
    return '';
}

function extractDirection(line) {
    if (typeof line !== 'string') return '';
    // Match TRACE/Trace followed by SKI (40 hex chars) followed by Recv/Send
    const m = line.match(/TRACE\s+[a-fA-F0-9]{40}\s+(Recv|Send)/i) || line.match(/Trace\s+[a-fA-F0-9]{40}\s+(Recv|Send)/i);
    return m ? m[1].toLowerCase() : '';
}

function extractJsonString(line) {
    if (typeof line !== 'string') return null;
    const idx = line.indexOf('{');
    if (idx === -1) return null;
    return line.slice(idx);
}

function findValueByKey(obj, key) {
    if (!obj || typeof obj !== 'object') return undefined;
    if (Object.prototype.hasOwnProperty.call(obj, key)) return obj[key];
    for (const k in obj) {
        if (!Object.prototype.hasOwnProperty.call(obj, k)) continue;
        const v = obj[k];
        if (typeof v === 'object') {
            const found = findValueByKey(v, key);
            if (found !== undefined) return found;
        }
    }
    return undefined;
}

function findCmdType(obj) {
    const cmd = findValueByKey(obj, 'cmd');
    if (!cmd) return '';
    
    function findObjInArray(a) {
        if (!Array.isArray(a)) return null;
        for (const item of a) {
            if (!item) continue;
            if (typeof item === 'object' && !Array.isArray(item)) {
                for (const k in item) {
                    if (Object.prototype.hasOwnProperty.call(item, k)) return k;
                }
            }
            if (Array.isArray(item)) {
                const deeper = findObjInArray(item);
                if (deeper) return deeper;
            }
        }
        return null;
    }
    
    const t = findObjInArray(cmd);
    return t || '';
}

function eebusJsonToJson(jsonStr) {
    if (typeof jsonStr !== 'string') jsonStr = String(jsonStr || '');
    try {
        let s = jsonStr;
        s = s.replace(/\[\]/g, '{}');
        s = s.replace(/\}\]/g, '}');
        s = s.replace(/\},\{/g, ',');
        s = s.replace(/\[\{/g, '{');
        s = s.trim();
        
        try {
            const parsed = JSON.parse(s);
            return JSON.stringify(parsed, null, 2);
        } catch (_) {
            return simplePretty(s);
        }
    } catch (e) {
        return jsonStr;
    }
}

function simplePretty(s) {
    let out = '';
    let indent = 0;
    const indentStr = () => '  '.repeat(indent);
    for (let i = 0; i < s.length; i++) {
        const ch = s[i];
        if (ch === '{' || ch === '[') {
            out += ch + '\n';
            indent++;
            out += indentStr();
        } else if (ch === '}' || ch === ']') {
            out += '\n';
            indent = Math.max(0, indent - 1);
            out += indentStr() + ch;
        } else if (ch === ',') {
            out += ch + '\n' + indentStr();
        } else {
            out += ch;
        }
    }
    return out;
}

// ========== API FUNCTIONS ==========

async function apiWrite(payload) {
    try {
        const res = await fetch('/api/write', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        const txt = await res.text();
        if (!res.ok) {
            alert('Write failed: ' + txt);
        }
    } catch (err) {
        alert('Request failed: ' + err);
    }
}

// ========== INITIALIZATION ==========

document.addEventListener('DOMContentLoaded', async () => {
    // Load configuration first so we can hide disabled usecases when creating tabs
    await loadConfig();

    // Initial fetch
    fetchPeers();
    
    // Connect WebSocket
    connectWebSocket();
    
    // Poll for peers list periodically
    setInterval(fetchPeers, 5000);
    
    // Poll active peer data
    setInterval(() => {
        if (peersState.activeTab !== 'peers-list') {
            const ski = peersState.activeTab.replace('peer-', '');
            refreshPeerData(ski);
        }
    }, 2000);
});
</script>
</body>
</html>
